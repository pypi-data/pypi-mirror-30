- name: "[calculate task_lists]"
  set_fact:
    freckle_task_lists: '{{ freckles_metadata | create_result_list_filter("ansible_task_lists", {"child_marker": "ansible_task_lists", "default_leaf": "task_lists", "default_leaf_key": "name", "key_move_map": {"*": "vars"}}) }}'

# - debug: var=freckles_metadata
# - debug: var=freckle_task_lists

- name: "[check whether .tasks.freckle file exists]"
  stat:
    path: "{{ freckle_path }}/.tasks.freckle"
  register: default_tasks_file

- name: "[set default task list]"
  set_fact:
     default_task_lists: [{'task_lists': {'name': '.tasks.freckle'}}]
  when: default_tasks_file.stat.exists

- name: "[set default task list]"
  set_fact:
     default_task_lists: ""
  when: not default_tasks_file.stat.exists

- name: "[check whether task list is set, otherwise use '.tasks.freckle' file]"
  set_fact:
    task_lists: "{{ freckle_task_lists | first_valid_default_list_filter(default_task_lists, []) }}"

# - debug: var=default_task_lists
# - debug: var=freckle_task_lists
# - debug: var=task_lists
#- fail: msg="SXS"

- name: including tasks
  include_tasks: "{{ freckle_path }}/{{ task_file['task_lists']['name'] }}"
  with_items:
    - "{{ task_lists }}"
  loop_control:
    loop_var: task_file
