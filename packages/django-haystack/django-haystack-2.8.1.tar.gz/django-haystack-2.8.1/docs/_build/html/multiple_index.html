
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Multiple Indexes &#8212; Haystack 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Rich Content Extraction" href="rich_content_extraction.html" />
    <link rel="prev" title="Signal Processors" href="signal_processors.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="multiple-indexes">
<span id="ref-multiple-index"></span><h1>Multiple Indexes<a class="headerlink" href="#multiple-indexes" title="Permalink to this headline">¶</a></h1>
<p>Much like Django’s <a class="reference external" href="http://docs.djangoproject.com/en/1.3/topics/db/multi-db/">multiple database support</a>, Haystack has “multiple index”
support. This allows you to talk to several different engines at the same time.
It enables things like master-slave setups, multiple language indexing,
separate indexes for general search &amp; autocomplete as well as other options.</p>
<div class="section" id="specifying-available-connections">
<h2>Specifying Available Connections<a class="headerlink" href="#specifying-available-connections" title="Permalink to this headline">¶</a></h2>
<p>You can supply as many backends as you like, each with a descriptive name. A
complete setup that accesses all backends might look like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">HAYSTACK_CONNECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;haystack.backends.solr_backend.SolrEngine&#39;</span><span class="p">,</span>
        <span class="s1">&#39;URL&#39;</span><span class="p">:</span> <span class="s1">&#39;http://localhost:9001/solr/default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;TIMEOUT&#39;</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;INCLUDE_SPELLING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;BATCH_SIZE&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;SILENTLY_FAIL&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;autocomplete&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;haystack.backends.whoosh_backend.WhooshEngine&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/search/whoosh_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;STORAGE&#39;</span><span class="p">:</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
        <span class="s1">&#39;POST_LIMIT&#39;</span><span class="p">:</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s1">&#39;INCLUDE_SPELLING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;BATCH_SIZE&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;SILENTLY_FAIL&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;slave&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;xapian_backend.XapianEngine&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/search/xapian_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;INCLUDE_SPELLING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;BATCH_SIZE&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;SILENTLY_FAIL&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;haystack.backends.simple_backend.SimpleEngine&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SILENTLY_FAIL&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You are required to have at least one connection listed within
<code class="docutils literal"><span class="pre">HAYSTACK_CONNECTIONS</span></code>, it must be named <code class="docutils literal"><span class="pre">default</span></code> &amp; it must have a valid
<code class="docutils literal"><span class="pre">ENGINE</span></code> within it.</p>
</div>
<div class="section" id="management-commands">
<h2>Management Commands<a class="headerlink" href="#management-commands" title="Permalink to this headline">¶</a></h2>
<p>All management commands that manipulate data use <strong>ONLY</strong> one connection at a
time. By default, they use the <code class="docutils literal"><span class="pre">default</span></code> index but accept a <code class="docutils literal"><span class="pre">--using</span></code> flag
to specify a different connection. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">rebuild_index</span> <span class="o">--</span><span class="n">noinput</span> <span class="o">--</span><span class="n">using</span><span class="o">=</span><span class="n">whoosh</span>
</pre></div>
</div>
</div>
<div class="section" id="automatic-routing">
<h2>Automatic Routing<a class="headerlink" href="#automatic-routing" title="Permalink to this headline">¶</a></h2>
<p>To make the selection of the correct index easier, Haystack (like Django) has
the concept of “routers”. All provided routers are checked whenever a read or
write happens, in the order in which they are defined.</p>
<p>For read operations (when a search query is executed), the <code class="docutils literal"><span class="pre">for_read</span></code> method
of each router is called, until one of them returns an index, which is used for
the read operation.</p>
<p>For write operations (when a delete or update is executed), the <code class="docutils literal"><span class="pre">for_write</span></code>
method of each router is called, and the results are aggregated. All of the
indexes that were returned are then updated.</p>
<p>Haystack ships with a <code class="docutils literal"><span class="pre">DefaultRouter</span></code> enabled. It looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DefaultRouter</span><span class="p">(</span><span class="n">BaseRouter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DEFAULT_ALIAS</span>

    <span class="k">def</span> <span class="nf">for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DEFAULT_ALIAS</span>
</pre></div>
</div>
<p>This means that the default index is used for all read and write operations.</p>
<p>If the <code class="docutils literal"><span class="pre">for_read</span></code> or <code class="docutils literal"><span class="pre">for_write</span></code> method doesn’t exist or returns <code class="docutils literal"><span class="pre">None</span></code>,
that indicates that the current router can’t handle the data. The next router
is then checked.</p>
<p>The <code class="docutils literal"><span class="pre">for_write</span></code> method can return either a single string representing an
index name, or an iterable of such index names. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UpdateEverythingRouter</span><span class="p">(</span><span class="n">BaseRouter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;myindex1&#39;</span><span class="p">,</span> <span class="s1">&#39;myindex2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">hints</span></code> passed can be anything that helps the router make a decision. This
data should always be considered optional &amp; be guarded against. At current,
<code class="docutils literal"><span class="pre">for_write</span></code> receives an <code class="docutils literal"><span class="pre">index</span></code> option (pointing to the <code class="docutils literal"><span class="pre">SearchIndex</span></code>
calling it) while <code class="docutils literal"><span class="pre">for_read</span></code> may receive <code class="docutils literal"><span class="pre">models</span></code> (being a list of <code class="docutils literal"><span class="pre">Model</span></code>
classes the <code class="docutils literal"><span class="pre">SearchQuerySet</span></code> may be looking at).</p>
<p>You may provide as many routers as you like by overriding the
<code class="docutils literal"><span class="pre">HAYSTACK_ROUTERS</span></code> setting. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">HAYSTACK_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;myapp.routers.MasterRouter&#39;</span><span class="p">,</span> <span class="s1">&#39;myapp.routers.SlaveRouter&#39;</span><span class="p">,</span> <span class="s1">&#39;haystack.routers.DefaultRouter&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="master-slave-example">
<h3>Master-Slave Example<a class="headerlink" href="#master-slave-example" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">MasterRouter</span></code> &amp; <code class="docutils literal"><span class="pre">SlaveRouter</span></code> might look like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">haystack</span> <span class="k">import</span> <span class="n">routers</span>


<span class="k">class</span> <span class="nc">MasterRouter</span><span class="p">(</span><span class="n">routers</span><span class="o">.</span><span class="n">BaseRouter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;master&#39;</span>

    <span class="k">def</span> <span class="nf">for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">SlaveRouter</span><span class="p">(</span><span class="n">routers</span><span class="o">.</span><span class="n">BaseRouter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;slave&#39;</span>
</pre></div>
</div>
<p>The observant might notice that since the methods don’t overlap, this could be
combined into one <code class="docutils literal"><span class="pre">Router</span></code> like so:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">haystack</span> <span class="k">import</span> <span class="n">routers</span>


<span class="k">class</span> <span class="nc">MasterSlaveRouter</span><span class="p">(</span><span class="n">routers</span><span class="o">.</span><span class="n">BaseRouter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;master&#39;</span>

    <span class="k">def</span> <span class="nf">for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;slave&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="manually-selecting">
<h2>Manually Selecting<a class="headerlink" href="#manually-selecting" title="Permalink to this headline">¶</a></h2>
<p>There may be times when automatic selection of the correct index is undesirable,
such as when fixing erroneous data in an index or when you know exactly where
data should be located.</p>
<p>For this, the <code class="docutils literal"><span class="pre">SearchQuerySet</span></code> class allows for manually selecting the index
via the <code class="docutils literal"><span class="pre">SearchQuerySet.using</span></code> method:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">haystack.query</span> <span class="k">import</span> <span class="n">SearchQuerySet</span>

<span class="c1"># Uses the routers&#39; opinion.</span>
<span class="n">sqs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">auto_query</span><span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">)</span>

<span class="c1"># Forces the default.</span>
<span class="n">sqs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">auto_query</span><span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">)</span>

<span class="c1"># Forces the slave connection (presuming it was setup).</span>
<span class="n">sqs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s1">&#39;slave&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">auto_query</span><span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note that the models a <code class="docutils literal"><span class="pre">SearchQuerySet</span></code> is trying to pull from must all come
from the same index. Haystack is not able to combine search queries against
different indexes.</p>
</div>
</div>
<div class="section" id="custom-index-selection">
<h2>Custom Index Selection<a class="headerlink" href="#custom-index-selection" title="Permalink to this headline">¶</a></h2>
<p>If a specific backend has been selected, the <code class="docutils literal"><span class="pre">SearchIndex.index_queryset</span></code> and
<code class="docutils literal"><span class="pre">SearchIndex.read_queryset</span></code> will receive the backend name, giving indexes the
opportunity to customize the returned queryset.</p>
<p>For example, a site which uses separate indexes for recent items and older
content might define <code class="docutils literal"><span class="pre">index_queryset</span></code> to filter the items based on date:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">index_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">archive_limit</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">using</span> <span class="o">==</span> <span class="s2">&quot;archive&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__lte</span><span class="o">=</span><span class="n">archive_limit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__gte</span><span class="o">=</span><span class="n">archive_limit</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="multi-lingual-content">
<h3>Multi-lingual Content<a class="headerlink" href="#multi-lingual-content" title="Permalink to this headline">¶</a></h3>
<p>Most search engines require you to set the language at the index level. For
example, a multi-lingual site using Solr can use <a class="reference external" href="http://wiki.apache.org/solr/CoreAdmin">multiple cores</a> and corresponding Haystack
backends using the language name. Under this scenario, queries are simple:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>sqs = SearchQuerySet.using(lang).auto_query(…)
</pre></div>
</div>
<p>During index updates, the Index’s <code class="docutils literal"><span class="pre">index_queryset</span></code> method will need to filter
the items to avoid sending the wrong content to the search engine:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">index_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="toc.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Multiple Indexes</a><ul>
<li><a class="reference internal" href="#specifying-available-connections">Specifying Available Connections</a></li>
<li><a class="reference internal" href="#management-commands">Management Commands</a></li>
<li><a class="reference internal" href="#automatic-routing">Automatic Routing</a><ul>
<li><a class="reference internal" href="#master-slave-example">Master-Slave Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#manually-selecting">Manually Selecting</a></li>
<li><a class="reference internal" href="#custom-index-selection">Custom Index Selection</a><ul>
<li><a class="reference internal" href="#multi-lingual-content">Multi-lingual Content</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="toc.html">Documentation overview</a><ul>
  <li><a href="index.html">Welcome to Haystack!</a><ul>
      <li>Previous: <a href="signal_processors.html" title="previous chapter">Signal Processors</a></li>
      <li>Next: <a href="rich_content_extraction.html" title="next chapter">Rich Content Extraction</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/multiple_index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2009-2016, Daniel Lindsley.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/multiple_index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>