if(typeof namespace_delimiter=="undefined")var namespace_delimiter=">";var getNamespace=function(e){var t=$(e).parents("[data-cms-namespace], [data-cms-content]")||[],n="";return t.length!=0&&t.each(function(e,t){var r=$(t).attr("data-cms-namespace");r||(r=$(t).attr("data-cms-content"),r.indexOf("md:")===0&&(r=r.slice(3))),n?n=r+namespace_delimiter+n:n=r}),n},showTooltip=function(e){e.stopPropagation();var t=e.currentTarget,n=t.attributes,o=$(".cms_tooltip span");if(n.hasOwnProperty("data-cms-content")){var u=n["data-cms-content"].value;u.indexOf("md:")===0&&(u=u.slice(3))}else if(n.hasOwnProperty("data-cms-attr")){var f=n["data-cms-attr"].value.split("|");u=f[0].slice(f[0].indexOf(":")+1)}var l=getNamespace(t);l&&(u=l+namespace_delimiter+u),o.html(u);var c=$(".cms_tooltip");c.css("visibility","visible").show();var h=20;i=e.pageX-$(c).offsetParent().offset().left,s=e.pageY-$(c).offsetParent().offset().top,r=$(c).offsetParent().width(),a=i+c.outerWidth(!0)+h,c.css({left:a>=r?i-c.outerWidth(!0)-h:i+h,top:s})},hideTooltip=function(){var e=$(".cms_tooltip");e.css("visibility","hidden").hide()},editables=$("[data-cms-attr],[data-cms-content]");editables.on("mousemove",showTooltip),editables.on("mouseout",hideTooltip),editables.on("click",function(e){e.preventDefault();var t=$(".cms_tooltip span").html();$('[class="editable"][id="'+t+'"]').click()}),$("#cms_toolbar_hide").on("click",function(){$(".cms_toolbar").css("visibility","hidden").hide(),$(".cms_toolbar_snippet").css("visibility","visible").show()}),$(".cms_toolbar_snippet").on("click",function(e){e.preventDefault(),$(this).css("visibility","hidden").hide(),$(".cms_toolbar").css("visibility","visible").show()});var default_opts={basePath:static_url,clientSideStorage:!0,localStorageName:local_storage_name,useNativeFullscreen:!0,parser:marked,file:{name:"epiceditor",defaultContent:"",autoSave:100},theme:{base:"https://cdnjs.cloudflare.com/ajax/libs/epiceditor/0.2.2/themes/base/epiceditor.css",preview:"https://cdnjs.cloudflare.com/ajax/libs/epiceditor/0.2.2/themes/preview/bartik.css",editor:"https://cdnjs.cloudflare.com/ajax/libs/epiceditor/0.2.2/themes/editor/epic-dark.css"},button:{preview:!0,fullscreen:!0,bar:"auto"},focusOnLoad:!0,shortcut:{modifier:18,fullscreen:70,preview:80},string:{togglePreview:"Toggle Preview Mode",toggleEdit:"Toggle Edit Mode",toggleFullscreen:"Enter Fullscreen"},autogrow:!0};$(document).ready(function(){function f(e){return e.replace(/\u00a0/g," ").replace(/&nbsp;/g," ")}function l(n,r){if(t&&e in t){var i=JSON.parse(t[e]);for(var s in i)if(i.hasOwnProperty(s)){tmp=i[s].modified;if(typeof o=="undefined")var o=tmp;tmp<o&&(o=tmp),console.log(o)}}var u={auth_data:JSON.stringify(r),csrfmiddlewaretoken:CSRF_TOKEN,draft_modified:typeof o=="undefined"?"":o.toString(),cms_page_id:cms_page_id};$.post(n,u,function(n){if(n.success)t.removeItem(e),location.reload(!0);else{console.log(n.message_in_detail),alert(n.message);if(n.draft_error||n.success==null)location.reload(!0),t.removeItem(e)}},"json")}var e=window.local_storage_name,t=window.localStorage,n={};if(t&&e in t){var r=JSON.parse(t[e]);for(var i in r)if(r.hasOwnProperty(i)){n[i]=r[i].content,date_in_draft=r[i].modified;if(modified_on>date_in_draft){t.removeItem(e),n={},alert("Draft data was out of date and has been cleared.");break}}}editables.each(function(e,t){var r=getNamespace(t);if(t.hasAttribute("data-cms-content")){var i=!1,s=$(t).attr("data-cms-content");s.indexOf("md:")===0&&(i=!0,s=s.slice(3)),r&&(s=r+namespace_delimiter+s);var o=$("<li/>"),u=s;i&&(u="*"+s),$("<div/>",{id:s,markdown:i,text:u}).addClass("editable").appendTo(o),$("<textarea/>",{id:s+"_content",text:n[s+"_editor"]||cms_data[s]||t.innerHTML,hidden:"hidden"}).appendTo(o),o.appendTo($(".cms_toolbar_list")),$("<div/>",{id:s+"_editor",style:"visibility: hidden;"}).appendTo($(".cms_editor #editors"))}t.hasAttribute("data-cms-attr")&&$(t).attr("data-cms-attr").split("|").forEach(function(e){var n=e.slice(e.indexOf(":")+1),i=e.slice(0,e.indexOf(":")),s=$("<li/>");r&&(n=r+namespace_delimiter+n),$("<div/>",{id:n,text:n,markdown:!1}).addClass("editable").appendTo(s),$("<textarea/>",{id:n+"_content",text:cms_data[n]||$(t).attr(i),hidden:"hidden"}).appendTo(s),s.appendTo($(".cms_toolbar_list")),$("<div/>",{id:n+"_editor",style:"visibility: hidden;"}).appendTo($(".cms_editor #editors"))})});var s=null,o=null,u=function(){$(".cms_editor").css("visibility","hidden").hide(),$(".cms_toolbar_list li").removeClass("cms_highlight"),$('[id$="_editor"]').css("visibility","hidden").hide(),s&&s.is("loaded")&&s.unload()};$(".cms_close").on("click",u),$(".editable").on("click",function(e){o=e.target.id;var t=o+"_editor";console.log(o);if($("#"+t).css("visibility")!="visible"){u(),$(this).parent().addClass("cms_highlight");var n=default_opts;n.container=t,n.textarea=o+"_content",n.file.name=t,$(".cms_editor").css("visibility","visible").show(),$("#"+t).css("visibility","visible").show(),s=new EpicEditor(n),s.load(function(){$("div#"+t).show()})}});var a=function(){var e={},t=s._getFileStore();for(var n in t)n&&n.endsWith("_editor")&&(e[n.replace("_editor","")]=f(t[n].content));return e};$("#save_content").on("click",function(e){e.preventDefault(),$(this).prop("disabled",!0),$.isEmptyObject(s)?alert("You changed nothing\n\nJon Snow"):l(draft_url,a()),$(this).prop("disabled",!1)}),$("#publish").on("click",function(e){e.preventDefault(),$(this).prop("disabled",!0);var t={};$.isEmptyObject(s)||(t=a()),l(publish_url,t),$(this).prop("disabled",!1)})});
