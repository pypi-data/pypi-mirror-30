{% extends '_base.html' %}

{% block page_title %}
    System Upgrading
{% endblock %}

{% block page_css %}

{% endblock %}

{% block body %}
<div class="overlay gray-bg">
    <div class="middle-box animated fadeInDown">
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>{{ target }} Upgrade in Progress</h5>
                    </div>
                    <div class="ibox-content">
                        <div class="spiner-example">
                            <div class="sk-spinner sk-spinner-cube-grid">
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                                <div class="sk-cube"></div>
                            </div>
                        </div>
                    </div>
                    <div class="ibox-footer text-center">
                        <div id="upg_progress" style="display: inline">
                            <h5>Upgrade Progress</h5>
                            <div class="progress progress-striped active">
                                <div id="progress_bar" style="width: 0%" aria-valuemax="100" aria-valuemin="0" aria-valuenow="75"
                                     role="progressbar" class="progress-bar progress-bar-navy-light">
                                    <span class="sr-only">40% Complete (success)</span>
                                </div>
                            </div>
                        </div>
                        <div class="warning" id="upg_warning" style="display: none;">
                            <h5 class="text-warning">An internal Error has occurred. Please reboot</h5>
                            <div>
                                <button class="btn btn-danger btn-rounded" id="warning_reboot_btn">
                                    <i class="fa fa-power-off"></i> Reboot System
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}
        {% include '_footer.html' %}
    {% endblock %}
    {% block page_js %}
        {{ super() }}
        <script>
            $(document).ready(function(){
                var failed_attempts = 0;
                var progress = 0;
                var id = '{{ task_id }}';

                function _wait_for_web_restart(){
                    var upg_timeout = setInterval(function(){
                        $.ajax({
                            type: 'HEAD',
                            url: '{{ domain }}',
                            success: function(){
                                clearInterval(upg_timeout);
                                window.location.href = '{{ domain }}';
                            },
                            error: function(){
                                failed_attempts++;
                                console.log('Error in querying for page head');
                            }
                        });
                        // Waits for 5 minutes
                        if(failed_attempts >= 60 * 5){
                            clearInterval(upg_timeout);
                            $('#upg_warning').show();
                            $('#upg_progress').hide();
                        }
                    }, 1000);
                }

                function _upgrade_complete(target){
                    $.ajax({
                        method: 'POST',
                        url: '/system/restart',
                        data:{'target' : target}
                    });
                }

                var status_timeout = setInterval(function(){
                    var target = '{{ target }}';
                    $.ajax({
                        url: '/system/upgrade_status/' + id,
                        success: function(data, status, request){
                            if(data.state === 'SUCCESS'){
                                $('#progress_bar').css({'width': 100 + '%'});
                                clearInterval(status_timeout);
                                toastr.success('Update complete, restarting', 'UPDATE');

                                if(target === 'modislock'){
                                    _upgrade_complete(target);
                                    _wait_for_web_restart();
                                } else if(target === 'modislock-monitor'){
                                    _upgrade_complete(target);
                                    window.location.href = '{{ domain }}';
                                }
                            } else if( data.state === 'PROGRESS'){
                                if( progress < 90){
                                    progress++;
                                    $('#progress_bar').css({'width': progress + '%'});
                                }
                            } else if( data.state === 'FAILURE' || data.state === 'ERROR' ){
                                toastr.error('Error upgrading', 'UPDATE');
                            }
                        },
                        error: function(){
                            console.log('Error');
                        }
                    });
                }, 500);

                $('#warning_reboot_btn').click(function(){
                    _upgrade_complete('modislock-system');
                });
            });
        </script>
    {% endblock %}
</div>
{% endblock %}