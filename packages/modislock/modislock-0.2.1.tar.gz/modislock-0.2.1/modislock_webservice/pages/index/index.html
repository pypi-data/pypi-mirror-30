{% extends "_template_page.html" %}

{% block page_title %}Modis Lock{% endblock %}

{% block page_css %}
    {% assets 'tables_css' %}
        <link href="{{ ASSET_URL }}" rel="stylesheet">
    {% endassets %}
{% endblock %}

{% block page_heading %}
    <h2><i class="fa fa-fw fa-dashboard"></i> Dashboard</h2>
{% endblock %}

{% block page_name %}
    Dashboard
{% endblock %}

{% block page_content %}
        <div class="row">
            <div class="col-lg-7">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <div>
                            <span class="pull-right text-right">
                                <small>Number of validations and denies in the last 24hours</small>
                            </span>
                            <h3 class="font-bold no-margins">Validations</h3>
                            <small>Approved/Denied</small>
                        </div>
                        <div class="m-t-sm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div>
                                        <canvas id="lineChart" height="114"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <ul class="stat-list m-t-lg">
                                        <li>
                                            <h2 class="no-margins">{{ valid_count }}</h2>
                                            <small>Total validations</small>
                                            <div class="progress progress-mini">
                                                <div class="progress-bar" style="width: {{ "%d" | format((valid_count/1000) * 100) }}%;"></div>
                                            </div>
                                        </li>
                                        <li>
                                            <h2 class="no-margins ">{{ denied_count }}</h2>
                                            <small>Total denials</small>
                                            <div class="progress progress-mini">
                                                <div class="progress-bar progress-bar-danger" style="width: {{ "%d" | format((denied_count/100) * 100) }}%;"></div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="m-t-md">
                            <small class="pull-right">
                                <i class="fa fa-clock-o"></i>
                                Updated on <script type="text/javascript">document.write(new Date());</script>
                            </small>
                            <small>
                                <strong>Analysis of validations:</strong>&nbsp;{% if attacks == True %}<span class="text-warning">Potential attack detected</span>{% else %}No attacks detected{% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="row">
                    <div class="col-md-7">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label {% if errors < 10 %}label-primary{% else %}label-warning{% endif %} pull-right">System Running</span>
                                <h5>System</h5>
                            </div>
                            <div class="ibox-content">
                                <div class="row text-center">
                                    <div class="col-xs-2">
                                        <small class="stats-label text-success" data-toggle="tooltip" data-placement="top" title="System Temp">System&nbsp;<span><i class="fa fa-thermometer-empty"></i></span></small>
                                        <h4 class="{% if system['host_temp'] > 50 and system['host_temp'] < 60 %}text-warning{% elif system['host_temp'] > 60 %}text-danger{% else %}text_primary{% endif %}">{{ system['host_temp'] }}&deg;C</h4>
                                    </div>
                                    <div class="col-xs-2">
                                        <small class="stats-label text-success" data-toggle="tooltip" data-placement="top" title="CPU Temp">CPU&nbsp;<span><i class="fa fa-thermometer-empty"></i></span></small>
                                        <h4 class="{% if system['cpu_temp'] > 50 and system['cpu_temp'] < 60 %}text-warning{% elif system['cpu_temp'] > 60 %}text-danger{% else %}text_primary{% endif %}">{{ system['cpu_temp'] }}&deg;C</h4>
                                    </div>
                                    <div class="col-xs-2">
                                        <small class="stats-label text-success" data-toggle="tooltip" data-placement="top" title="Storage space free">D.Free&nbsp;<span><i class="fa fa-database"></i></span></small>
                                        <h4>{{ '%0.1f'| format(100-storage|float) }}%</h4>
                                    </div>
                                    <div class="col-xs-2">
                                        <small class="stats-label text-success" data-toggle="tooltip" data-placement="top" title="Memory free">M.Free&nbsp;<span><i class="fa fa-microchip"></i></span></small>
                                        <h4>{{ '%0.1f' | format((memory_free/memory_total) * 100|float) }}%</h4>
                                    </div>
                                    <div class="col-xs-3 col-xs-offset-1">
                                        <small class="stats-label text-success" data-toggle="tooltip" data-placement="top" title="Door sensor 1 status">DOOR 1&nbsp;<span><i class="fa fa-circle"></i></span></small>
                                        <img id="door1_sensor" src="{% if door1 == False %}static/img/DoorClosed.png{% else %}static/img/DoorOpen.png{% endif %}" width="60">
                                    </div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-xs-3">
                                        <small class="stats-label text-info" data-toggle="tooltip" data-placement="top" title="System Uptime">Uptime&nbsp;<span><i class="fa fa-clock-o"></i></span></small>
                                        {% set days = system['uptime'] // 60 // 60 // 24 %}
                                        {% set hours = (system['uptime'] // 60 // 60) % 24 %}
                                        {% set minutes = (system['uptime'] // 60) % 60 %}
                                        <h4>{{ days }}d:{{ hours }}h:{{ minutes }}m</h4>
                                    </div>
                                    <div class="col-xs-3">
                                        <small class="stats-label text-warning" data-toggle="tooltip" data-placement="top" title="System Warnings">Warnings&nbsp;<span><i class="fa fa-warning"></i></span></small>
                                        <h4>{{ errors }}</h4>
                                    </div>
                                    <div class="col-xs-3 col-xs-offset-3">
                                        <small class="stats-label text-success" data-toggle="tooltip" data-placement="top" title="Door sensor 2 status">DOOR 2&nbsp;<span><i class="fa fa-circle"></i></span></small>
                                        <img id="door2_sensor" src="{% if door2 == False %}static/img/DoorClosed.png{% else %}static/img/DoorOpen.png{% endif %}" width="60">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>Readers</h5>
                                <span class="label {% if reader_count > 0 %}label-primary{% else %}label-warning{% endif %} pull-right">
                                    {% if reader_count > 0 %}Connected{% else %}!Connected{% endif %}
                                </span>
                            </div>
                            <div class="ibox-content">
                                <h1 class="no-margins">{{ reader_count }}</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            {# Recent Events #}
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>Recent Activity</h5>
                    </div>
                    <div class="ibox-context">
                        <table id="event_table" class="table table-striped table-bordered dataTables" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Event Type</th>
                                    <th>Event Time</th>
                                    <th>Event Location</th>
                                    <th>Event Direction</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block page_js %}
    {{ super() }}
    {% assets 'tables_js' %}
        <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
    {% assets 'index_js' %}
        <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
    <script>
        $(document).ready(function(){
            var ctx = document.getElementById("lineChart").getContext("2d");

            var approved = {{ summary['approved'] }};
            var denied = {{ summary['denied'] }};

            var today = new Date;
            today.setHours(today.getHours() - 23);
            var hour = today.getHours();
            var hours = [];

            for(var i = 0; i < 24; i++)
            {
                hours[i] = (hour < 10) ? "0" + hour + ":00" : hour + ":00";
                hour++;
                if( hour > 23 )
                    hour = 0;
            }

            var valid_chart = new Chart(ctx, {
                type: 'line',
                options: {
                    responsive: true,
                    scales: {
                        yAxes: [{
                            display: true,
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                },
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: "Validations",
                            backgroundColor: "rgba(26,179,148,0.5)",
                            borderColor: "rgba(26,179,148,0.7)",
                            pointBackgroundColor: "rgba(26,179,148,1)",
                            pointBorderColor: "#fff",
                            data: approved  //[234, 435, 55, 12, 15, 180, 45, 41, 12, 55, 201, 167, 80, 23, 6, 2, 0, 0, 0, 0, 0, 0, 0, 0]
                        },
                        {
                            label: "Denials",
                            backgroundColor: "rgba(220,0,0,0.5)",
                            borderColor: "rgba(220,0,0,1)",
                            pointBackgroundColor: "rgba(220,0,0,1)",
                            pointBorderColor: "#fff",
                            data: denied   // [12, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        }
                    ]
                }
            });

            setInterval(function(){
                $.ajax({
                   url: "/dashdata",
                   success: function(response) {
                       var src1 = (response.success.door1 === true) ? 'static/img/DoorOpen.png' : 'static/img/DoorClosed.png';
                       var src2 = (response.success.door2 === true) ? 'static/img/DoorOpen.png' : 'static/img/DoorClosed.png';
                       $("#door1_sensor").attr("src", src1);
                       $("#door2_sensor").attr("src", src2);
                   }
                });
            }, 500);
        });
    </script>
{% endblock %}

