
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tasks &#8212; Celery 4.2.0 documentation</title>
    <link rel="stylesheet" href="../_static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Calling Tasks" href="calling.html" />
    <link rel="prev" title="Application" href="application.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="calling.html" title="Calling Tasks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="application.html" title="Application"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Celery 4.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">User Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<div class="deck">

    
        <p>
        This document describes the current stable version of Celery (4.2).
        For development docs,
        <a href="http://docs.celeryproject.org/en/master/userguide/tasks.html">go here</a>.
        </p>
    

</div>
    <div class="section" id="tasks">
<span id="guide-tasks"></span><h1>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h1>
<p>Tasks are the building blocks of Celery applications.</p>
<p>A task is a class that can be created out of any callable. It performs
dual roles in that it defines both what happens when a task is
called (sends a message), and what happens when a worker receives that message.</p>
<p>Every task class has a unique name, and this name is referenced in messages
so the worker can find the right function to execute.</p>
<p>A task message is not removed from the queue
until that message has been <a class="reference internal" href="../glossary.html#term-acknowledged"><span class="xref std std-term">acknowledged</span></a> by a worker. A worker can reserve
many messages in advance and even if the worker is killed – by power failure
or some other reason – the message will be redelivered to another worker.</p>
<p>Ideally task functions should be <a class="reference internal" href="../glossary.html#term-idempotent"><span class="xref std std-term">idempotent</span></a>: meaning
the function won’t cause unintended effects even if called
multiple times with the same arguments.
Since the worker cannot detect if your tasks are idempotent, the default
behavior is to acknowledge the message in advance, just before it’s executed,
so that a task invocation that already started is never executed again.</p>
<p>If your task is idempotent you can set the <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a> option
to have the worker acknowledge the message <em>after</em> the task returns
instead. See also the FAQ entry <a class="reference internal" href="../faq.html#faq-acks-late-vs-retry"><span class="std std-ref">Should I use retry or acks_late?</span></a>.</p>
<p>Note that the worker will acknowledge the message if the child process executing
the task is terminated (either by the task calling <a class="reference external" href="https://docs.python.org/dev/library/sys.html#sys.exit" title="(in Python v3.8)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sys.exit()</span></code></a>, or by signal)
even when <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a> is enabled.  This behavior is by purpose
as…</p>
<ol class="arabic simple">
<li>We don’t want to rerun tasks that forces the kernel to send
a <code class="xref std std-sig docutils literal notranslate"><span class="pre">SIGSEGV</span></code> (segmentation fault) or similar signals to the process.</li>
<li>We assume that a system administrator deliberately killing the task
does not want it to automatically restart.</li>
<li>A task that allocates too much memory is in danger of triggering the kernel
OOM killer, the same may happen again.</li>
<li>A task that always fails when redelivered may cause a high-frequency
message loop taking down the system.</li>
</ol>
<p>If you really want a task to be redelivered in these scenarios you should
consider enabling the <a class="reference internal" href="configuration.html#std:setting-task_reject_on_worker_lost"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_reject_on_worker_lost</span></code></a> setting.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>A task that blocks indefinitely may eventually stop the worker instance
from doing any other work.</p>
<p>If you task does I/O then make sure you add timeouts to these operations,
like adding a timeout to a web request using the <a class="reference external" href="https://pypi.python.org/pypi/requests/">requests</a> library:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">connect_timeout</span><span class="p">,</span> <span class="n">read_timeout</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">30.0</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">,</span> <span class="n">read_timeout</span><span class="p">))</span>
</pre></div>
</div>
<p><a class="reference internal" href="workers.html#worker-time-limits"><span class="std std-ref">Time limits</span></a> are convenient for making sure all
tasks return in a timely manner, but a time limit event will actually kill
the process by force so only use them to detect cases where you haven’t
used manual timeouts yet.</p>
<p>The default prefork pool scheduler is not friendly to long-running tasks,
so if you have tasks that run for minutes/hours make sure you enable
the <a class="reference internal" href="../reference/celery.bin.worker.html#cmdoption-celery-worker-o"><code class="xref std std-option docutils literal notranslate"><span class="pre">-Ofair</span></code></a> command-line argument to
the <strong class="program">celery worker</strong>. See <a class="reference internal" href="optimizing.html#prefork-pool-prefetch"><span class="std std-ref">Prefork pool prefetch settings</span></a> for more
information, and for the best performance route long-running and
short-running tasks to dedicated workers (<a class="reference internal" href="routing.html#routing-automatic"><span class="std std-ref">Automatic routing</span></a>).</p>
<p class="last">If your worker hangs then please investigate what tasks are running
before submitting an issue, as most likely the hanging is caused
by one or more tasks hanging on a network operation.</p>
</div>
<p>–</p>
<p>In this chapter you’ll learn all about defining tasks,
and this is the <strong>table of contents</strong>:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#basics" id="id5">Basics</a></li>
<li><a class="reference internal" href="#names" id="id6">Names</a></li>
<li><a class="reference internal" href="#task-request" id="id7">Task Request</a></li>
<li><a class="reference internal" href="#logging" id="id8">Logging</a></li>
<li><a class="reference internal" href="#retrying" id="id9">Retrying</a></li>
<li><a class="reference internal" href="#list-of-options" id="id10">List of Options</a></li>
<li><a class="reference internal" href="#states" id="id11">States</a></li>
<li><a class="reference internal" href="#semipredicates" id="id12">Semipredicates</a></li>
<li><a class="reference internal" href="#custom-task-classes" id="id13">Custom task classes</a></li>
<li><a class="reference internal" href="#how-it-works" id="id14">How it works</a></li>
<li><a class="reference internal" href="#tips-and-best-practices" id="id15">Tips and Best Practices</a></li>
<li><a class="reference internal" href="#performance-and-strategies" id="id16">Performance and Strategies</a></li>
<li><a class="reference internal" href="#task-example" id="id17">Example</a></li>
</ul>
</div>
<div class="section" id="basics">
<span id="task-basics"></span><h2><a class="toc-backref" href="#id5">Basics</a><a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h2>
<p>You can easily create a task from any callable by using
the <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">task()</span></code></a> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>There are also many <a class="reference internal" href="#task-options"><span class="std std-ref">options</span></a> that can be set for the task,
these can be specified as arguments to the decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<div class="sidebar">
<p class="first sidebar-title">How do I import the task decorator? And what’s “app”?</p>
<p>The task decorator is available on your <a class="reference internal" href="../reference/celery.html#celery.Celery" title="celery.Celery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Celery</span></code></a> application instance,
if you don’t know what this is then please read <a class="reference internal" href="../getting-started/first-steps-with-celery.html#first-steps"><span class="std std-ref">First Steps with Celery</span></a>.</p>
<p>If you’re using Django (see <a class="reference internal" href="../django/first-steps-with-django.html#django-first-steps"><span class="std std-ref">First steps with Django</span></a>), or you’re the author
of a library then you probably want to use the <code class="xref py py-func docutils literal notranslate"><span class="pre">shared_task()</span></code> decorator:</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>

<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<div class="sidebar">
<p class="first sidebar-title">Multiple decorators</p>
<p>When using multiple decorators in combination with the task
decorator you must make sure that the <cite>task</cite>
decorator is applied last (oddly, in Python this means it must
be first in the list):</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="nd">@decorator2</span>
<span class="nd">@decorator1</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<div class="section" id="bound-tasks">
<h3>Bound tasks<a class="headerlink" href="#bound-tasks" title="Permalink to this headline">¶</a></h3>
<p>A task being bound means the first argument to the task will always
be the task instance (<code class="docutils literal notranslate"><span class="pre">self</span></code>), just like Python bound methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>Bound tasks are needed for retries (using <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a>),
for accessing information about the current task request, and for any
additional functionality you add to custom task base classes.</p>
</div>
<div class="section" id="task-inheritance">
<h3>Task inheritance<a class="headerlink" href="#task-inheritance" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">base</span></code> argument to the task decorator specifies the base class of the task:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">celery</span>

<span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">celery</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">einfo</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{0!r} failed: {1!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="names">
<span id="task-names"></span><h2><a class="toc-backref" href="#id6">Names</a><a class="headerlink" href="#names" title="Permalink to this headline">¶</a></h2>
<p>Every task must have a unique name.</p>
<p>If no explicit name is provided the task decorator will generate one for you,
and this name will be based on 1) the module the task is defined in, and 2)
the name of the task function.</p>
<p>Example setting explicit name:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app.task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sum-of-two-numbers&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;sum-of-two-numbers&#39;</span>
</pre></div>
</div>
<p>A best practice is to use the module name as a name-space,
this way names won’t collide if there’s already a task with that name
defined in another module.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app.task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tasks.add&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>You can tell the name of the task by investigating its <code class="docutils literal notranslate"><span class="pre">.name</span></code> attribute:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<p>The name we specified here (<code class="docutils literal notranslate"><span class="pre">tasks.add</span></code>) is exactly the name that would’ve
been automatically generated for us if the task was defined in a module
named <code class="file docutils literal notranslate"><span class="pre">tasks.py</span></code>:</p>
<p><code class="file docutils literal notranslate"><span class="pre">tasks.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<div class="section" id="automatic-naming-and-relative-imports">
<span id="task-naming-relative-imports"></span><h3>Automatic naming and relative imports<a class="headerlink" href="#automatic-naming-and-relative-imports" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">Absolute Imports</p>
<p>The best practice for developers targeting Python 2 is to add the
following to the top of <strong>every module</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
</pre></div>
</div>
<p>This will force you to always use absolute imports so you will
never have any problems with tasks using relative names.</p>
<p class="last">Absolute imports are the default in Python 3 so you don’t need this
if you target that version.</p>
</div>
<p>Relative imports and automatic name generation don’t go well together,
so if you’re using relative imports you should set the name explicitly.</p>
<p>For example if the client imports the module <code class="docutils literal notranslate"><span class="pre">&quot;myapp.tasks&quot;</span></code>
as <code class="docutils literal notranslate"><span class="pre">&quot;.tasks&quot;</span></code>, and the worker imports the module as <code class="docutils literal notranslate"><span class="pre">&quot;myapp.tasks&quot;</span></code>,
the generated names won’t match and an <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.NotRegistered" title="celery.exceptions.NotRegistered"><code class="xref py py-exc docutils literal notranslate"><span class="pre">NotRegistered</span></code></a> error will
be raised by the worker.</p>
<p>This is also the case when using Django and using <code class="docutils literal notranslate"><span class="pre">project.myapp</span></code>-style
naming in <code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;project.myapp&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>If you install the app under the name <code class="docutils literal notranslate"><span class="pre">project.myapp</span></code> then the
tasks module will be imported as <code class="docutils literal notranslate"><span class="pre">project.myapp.tasks</span></code>,
so you must make sure you always import the tasks using the same name:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">project.myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>   <span class="c1"># &lt;&lt; GOOD</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>    <span class="c1"># &lt;&lt; BAD!!!</span>
</pre></div>
</div>
<p>The second example will cause the task to be named differently
since the worker and the client imports the modules under different names:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">project.myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mytask</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;project.myapp.tasks.mytask&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mytask</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;myapp.tasks.mytask&#39;</span>
</pre></div>
</div>
<p>For this reason you must be consistent in how you
import modules, and that is also a Python best practice.</p>
<p>Similarly, you shouldn’t use old-style relative imports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">module</span> <span class="kn">import</span> <span class="n">foo</span>   <span class="c1"># BAD!</span>

<span class="kn">from</span> <span class="nn">proj.module</span> <span class="kn">import</span> <span class="n">foo</span>  <span class="c1"># GOOD!</span>
</pre></div>
</div>
<p>New-style relative imports are fine and can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.module</span> <span class="kn">import</span> <span class="n">foo</span>  <span class="c1"># GOOD!</span>
</pre></div>
</div>
<p>If you want to use Celery with a project already using these patterns
extensively and you don’t have the time to refactor the existing code
then you can consider specifying the names explicitly instead of relying
on the automatic naming:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;proj.tasks.add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-the-automatic-naming-behavior">
<span id="task-name-generator-info"></span><h3>Changing the automatic naming behavior<a class="headerlink" href="#changing-the-automatic-naming-behavior" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.0.</span></p>
</div>
<p>There are some cases when the default automatic naming isn’t suitable.
Consider you have many tasks within many different modules:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">project</span><span class="o">/</span>
       <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">celery</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">moduleA</span><span class="o">/</span>
               <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
               <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">moduleB</span><span class="o">/</span>
               <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
               <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Using the default automatic naming, each task will have a generated name
like <cite>moduleA.tasks.taskA</cite>, <cite>moduleA.tasks.taskB</cite>, <cite>moduleB.tasks.test</cite>,
and so on. You may want to get rid of having <cite>tasks</cite> in all task names.
As pointed above, you can explicitly give names for all tasks, or you
can change the automatic naming behavior by overriding
<a class="reference internal" href="../reference/celery.html#celery.Celery.gen_task_name" title="celery.Celery.gen_task_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.gen_task_name()</span></code></a>. Continuing with the example, <cite>celery.py</cite>
may contain:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="k">class</span> <span class="nc">MyCelery</span><span class="p">(</span><span class="n">Celery</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">gen_task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tasks&#39;</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyCelery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">gen_task_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyCelery</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>So each task will have a name like <cite>moduleA.taskA</cite>, <cite>moduleA.taskB</cite> and
<cite>moduleB.test</cite>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure that your <a class="reference internal" href="../reference/celery.html#celery.Celery.gen_task_name" title="celery.Celery.gen_task_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.gen_task_name()</span></code></a> is a pure function: meaning
that for the same input it must always return the same output.</p>
</div>
</div>
</div>
<div class="section" id="task-request">
<span id="task-request-info"></span><h2><a class="toc-backref" href="#id7">Task Request</a><a class="headerlink" href="#task-request" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.request" title="celery.app.task.Task.request"><code class="xref py py-attr docutils literal notranslate"><span class="pre">app.Task.request</span></code></a> contains information and state
related to the currently executing task.</p>
<p>The request defines the following attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">The unique id of the executing task.</td>
</tr>
<tr class="field-even field"><th class="field-name">group:</th><td class="field-body">The unique id of the task’s <a class="reference internal" href="canvas.html#canvas-group"><span class="std std-ref">group</span></a>, if this task is a member.</td>
</tr>
<tr class="field-odd field"><th class="field-name">chord:</th><td class="field-body">The unique id of the chord this task belongs to (if the task
is part of the header).</td>
</tr>
<tr class="field-even field"><th class="field-name">correlation_id:</th><td class="field-body">Custom ID used for things like de-duplication.</td>
</tr>
<tr class="field-odd field"><th class="field-name">args:</th><td class="field-body">Positional arguments.</td>
</tr>
<tr class="field-even field"><th class="field-name">kwargs:</th><td class="field-body">Keyword arguments.</td>
</tr>
<tr class="field-odd field"><th class="field-name">origin:</th><td class="field-body">Name of host that sent this task.</td>
</tr>
<tr class="field-even field"><th class="field-name">retries:</th><td class="field-body">How many times the current task has been retried.
An integer starting at <cite>0</cite>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">is_eager:</th><td class="field-body">Set to <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> if the task is executed locally in
the client, not by a worker.</td>
</tr>
<tr class="field-even field"><th class="field-name">eta:</th><td class="field-body">The original ETA of the task (if any).
This is in UTC time (depending on the <a class="reference internal" href="configuration.html#std:setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>
setting).</td>
</tr>
<tr class="field-odd field"><th class="field-name">expires:</th><td class="field-body">The original expiry time of the task (if any).
This is in UTC time (depending on the <a class="reference internal" href="configuration.html#std:setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>
setting).</td>
</tr>
<tr class="field-even field"><th class="field-name">hostname:</th><td class="field-body">Node name of the worker instance executing the task.</td>
</tr>
<tr class="field-odd field"><th class="field-name">delivery_info:</th><td class="field-body">Additional message delivery information. This is a mapping
containing the exchange and routing key used to deliver this
task. Used by for example <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a>
to resend the task to the same destination queue.
Availability of keys in this dict depends on the
message broker used.</td>
</tr>
<tr class="field-even field"><th class="field-name">reply-to:</th><td class="field-body">Name of queue to send replies back to (used with RPC result
backend for example).</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">called_directly:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body">This flag is set to true if the task wasn’t
executed by the worker.</td>
</tr>
<tr class="field-even field"><th class="field-name">timelimit:</th><td class="field-body">A tuple of the current <code class="docutils literal notranslate"><span class="pre">(soft,</span> <span class="pre">hard)</span></code> time limits active for
this task (if any).</td>
</tr>
<tr class="field-odd field"><th class="field-name">callbacks:</th><td class="field-body">A list of signatures to be called if this task returns successfully.</td>
</tr>
<tr class="field-even field"><th class="field-name">errback:</th><td class="field-body">A list of signatures to be called if this task fails.</td>
</tr>
<tr class="field-odd field"><th class="field-name">utc:</th><td class="field-body">Set to true the caller has UTC enabled (<a class="reference internal" href="configuration.html#std:setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>).</td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.1.</span></p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">headers:</th><td class="field-body">Mapping of message headers sent with this task message
(may be <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>).</td>
</tr>
<tr class="field-even field"><th class="field-name">reply_to:</th><td class="field-body">Where to send reply to (queue name).</td>
</tr>
<tr class="field-odd field"><th class="field-name">correlation_id:</th><td class="field-body">Usually the same as the task id, often used in amqp
to keep track of what a reply is for.</td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.0.</span></p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">root_id:</th><td class="field-body">The unique id of the first task in the workflow this task
is part of (if any).</td>
</tr>
<tr class="field-even field"><th class="field-name">parent_id:</th><td class="field-body">The unique id of the task that called this task (if any).</td>
</tr>
<tr class="field-odd field"><th class="field-name">chain:</th><td class="field-body">Reversed list of tasks that form a chain (if any).
The last item in this list will be the next task to succeed the
current task.  If using version one of the task protocol the chain
tasks will be in <code class="docutils literal notranslate"><span class="pre">request.callbacks</span></code> instead.</td>
</tr>
</tbody>
</table>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>An example task accessing information in the context is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Executing task id {0.id}, args: {0.args!r} kwargs: {0.kwargs!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">bind</span></code> argument means that the function will be a “bound method” so
that you can access attributes and methods on the task type instance.</p>
</div>
</div>
<div class="section" id="logging">
<span id="task-logging"></span><h2><a class="toc-backref" href="#id8">Logging</a><a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>The worker will automatically set up logging for you, or you can
configure logging manually.</p>
<p>A special logger is available named “celery.task”, you can inherit
from this logger to automatically get the task name and unique id as part
of the logs.</p>
<p>The best practice is to create a common logger
for all of your tasks at the top of your module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_task_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding {0} + {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>Celery uses the standard Python logger library,
and the documentation can be found <a class="reference external" href="https://docs.python.org/dev/library/logging.html#module-logging" title="(in Python v3.8)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>You can also use <a class="reference external" href="https://docs.python.org/dev/library/functions.html#print" title="(in Python v3.8)"><code class="xref py py-func docutils literal notranslate"><span class="pre">print()</span></code></a>, as anything written to standard
out/-err will be redirected to the logging system (you can disable this,
see <a class="reference internal" href="configuration.html#std:setting-worker_redirect_stdouts"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_redirect_stdouts</span></code></a>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The worker won’t update the redirection if you create a logger instance
somewhere in your task or task module.</p>
<p>If you want to redirect <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> to a custom
logger you have to enable this manually, for example:</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">old_outs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">rlevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">worker_redirect_stdouts_level</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">redirect_stdouts_to_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">rlevel</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Adding {0} + {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_outs</span>
</pre></div>
</div>
</div>
<div class="section" id="argument-checking">
<span id="task-argument-checking"></span><h3>Argument checking<a class="headerlink" href="#argument-checking" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.0.</span></p>
</div>
<p>Celery will verify the arguments passed when you call the task, just
like Python does when calling a normal function:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app.task</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="go"># Calling the task with two arguments works:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="go">&lt;AsyncResult: f59d71ca-1549-43e0-be41-4e8821a83c0c&gt;</span>

<span class="go"># Calling the task with only one argument fails:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;celery/app/task.py&quot;</span>, line <span class="m">376</span>, in <span class="n">delay</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
  File <span class="nb">&quot;celery/app/task.py&quot;</span>, line <span class="m">485</span>, in <span class="n">apply_async</span>
    <span class="n">check_arguments</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">()),</span> <span class="o">**</span><span class="p">(</span><span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{}))</span>
<span class="gr">TypeError</span>: <span class="n">add() takes exactly 2 arguments (1 given)</span>
</pre></div>
</div>
<p>You can disable the argument checking for any task by setting its
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.typing" title="celery.app.task.Task.typing"><code class="xref py py-attr docutils literal notranslate"><span class="pre">typing</span></code></a> attribute to <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app.task</span><span class="p">(</span><span class="n">typing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="go"># Works locally, but the worker reciving the task will raise an error.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="go">&lt;AsyncResult: f59d71ca-1549-43e0-be41-4e8821a83c0c&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="hiding-sensitive-information-in-arguments">
<span id="task-hiding-sensitive-information"></span><h3>Hiding sensitive information in arguments<a class="headerlink" href="#hiding-sensitive-information-in-arguments" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.0.</span></p>
</div>
<p>When using <a class="reference internal" href="configuration.html#std:setting-task_protocol"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_protocol</span></code></a> 2 or higher (default since 4.0), you can
override how positional arguments and keyword arguments are represented in logs
and monitoring events using the <code class="docutils literal notranslate"><span class="pre">argsrepr</span></code> and <code class="docutils literal notranslate"><span class="pre">kwargsrepr</span></code> calling
arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">argsrepr</span><span class="o">=</span><span class="s1">&#39;(&lt;secret-x&gt;, &lt;secret-y&gt;)&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">charge</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">card</span><span class="o">=</span><span class="s1">&#39;1234 5678 1234 5678&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">kwargsrepr</span><span class="o">=</span><span class="nb">repr</span><span class="p">({</span><span class="s1">&#39;card&#39;</span><span class="p">:</span> <span class="s1">&#39;**** **** **** 5678&#39;</span><span class="p">})</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Sensitive information will still be accessible to anyone able
to read your task message from the broker, or otherwise able intercept it.</p>
<p class="last">For this reason you should probably encrypt your message if it contains
sensitive information, or in this example with a credit card number
the actual number could be stored encrypted in a secure store that you retrieve
and decrypt in the task itself.</p>
</div>
</div>
</div>
<div class="section" id="retrying">
<span id="task-retry"></span><h2><a class="toc-backref" href="#id9">Retrying</a><a class="headerlink" href="#retrying" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> can be used to re-execute the task,
for example in the event of recoverable errors.</p>
<p>When you call <code class="docutils literal notranslate"><span class="pre">retry</span></code> it’ll send a new message, using the same
task-id, and it’ll take care to make sure the message is delivered
to the same queue as the originating task.</p>
<p>When a task is retried this is also recorded as a task state,
so that you can track the progress of the task using the result
instance (see <a class="reference internal" href="#task-states"><span class="std std-ref">States</span></a>).</p>
<p>Here’s an example using <code class="docutils literal notranslate"><span class="pre">retry</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> call will raise an exception so any
code after the retry won’t be reached. This is the <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Retry" title="celery.exceptions.Retry"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Retry</span></code></a>
exception, it isn’t handled as an error but rather as a semi-predicate
to signify to the worker that the task is to be retried,
so that it can store the correct state when a result backend is enabled.</p>
<p class="last">This is normal operation and always happens unless the
<code class="docutils literal notranslate"><span class="pre">throw</span></code> argument to retry is set to <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code>.</p>
</div>
<p>The bind argument to the task decorator will give access to <code class="docutils literal notranslate"><span class="pre">self</span></code> (the
task type instance).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">exc</span></code> method is used to pass exception information that’s
used in logs, and when storing task results.
Both the exception and the traceback will
be available in the task state (if a result backend is enabled).</p>
<p>If the task has a <code class="docutils literal notranslate"><span class="pre">max_retries</span></code> value the current exception
will be re-raised if the max number of retries has been exceeded,
but this won’t happen if:</p>
<ul>
<li><p class="first">An <code class="docutils literal notranslate"><span class="pre">exc</span></code> argument wasn’t given.</p>
<blockquote>
<div><p>In this case the <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.MaxRetriesExceededError" title="celery.exceptions.MaxRetriesExceededError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a>
exception will be raised.</p>
</div></blockquote>
</li>
<li><p class="first">There’s no current exception</p>
<blockquote>
<div><p>If there’s no original exception to re-raise the <code class="docutils literal notranslate"><span class="pre">exc</span></code>
argument will be used instead, so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">())</span>
</pre></div>
</div>
<p>will raise the <code class="docutils literal notranslate"><span class="pre">exc</span></code> argument given.</p>
</div></blockquote>
</li>
</ul>
<div class="section" id="using-a-custom-retry-delay">
<span id="task-retry-custom-delay"></span><h3>Using a custom retry delay<a class="headerlink" href="#using-a-custom-retry-delay" title="Permalink to this headline">¶</a></h3>
<p>When a task is to be retried, it can wait for a given amount of time
before doing so, and the default delay is defined by the
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.default_retry_delay" title="celery.app.task.Task.default_retry_delay"><code class="xref py py-attr docutils literal notranslate"><span class="pre">default_retry_delay</span></code></a>
attribute. By default this is set to 3 minutes. Note that the
unit for setting the delay is in seconds (int or float).</p>
<p>You can also provide the <cite>countdown</cite> argument to <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a> to
override this default.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># retry in 30 minutes.</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">something_raising</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="c1"># overrides the default delay to retry after 1 minute</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="automatic-retry-for-known-exceptions">
<span id="task-autoretry"></span><h3>Automatic retry for known exceptions<a class="headerlink" href="#automatic-retry-for-known-exceptions" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.0.</span></p>
</div>
<p>Sometimes you just want to retry a task whenever a particular exception
is raised.</p>
<p>Fortunately, you can tell Celery to automatically retry a task using
<cite>autoretry_for</cite> argument in <cite>~&#64;Celery.task</cite> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twitter.exceptions</span> <span class="kn">import</span> <span class="n">FailWhaleError</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">FailWhaleError</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to specify custom arguments for internal <cite>~&#64;Task.retry</cite>
call, pass <cite>retry_kwargs</cite> argument to <cite>~&#64;Celery.task</cite> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">FailWhaleError</span><span class="p">,),</span>
          <span class="n">retry_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_retries&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>This is provided as an alternative to manually handling the exceptions,
and the example above will do the same as wrapping the task body
in a <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#try" title="(in Python v3.8)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">try</span></code></a> … <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#except" title="(in Python v3.8)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">except</span></code></a> statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FailWhaleError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">div</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to automatically retry on any error, simply use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">x</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.1.</span></p>
</div>
<p>If your tasks depend on another service, like making a request to an API,
then it’s a good idea to use <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a> to avoid overwhelming the
service with your requests. Fortunately, Celery’s automatic retry support
makes it easy. Just specify the <a class="reference internal" href="#Task.retry_backoff" title="Task.retry_backoff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_backoff</span></code></a> argument, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">RequestException</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">RequestException</span><span class="p">,),</span> <span class="n">retry_backoff</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">x</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>By default, this exponential backoff will also introduce random <a class="reference external" href="https://en.wikipedia.org/wiki/Jitter">jitter</a> to
avoid having all the tasks run at the same moment. It will also cap the
maximum backoff delay to 10 minutes. All these settings can be customized
via options documented below.</p>
<dl class="attribute">
<dt id="Task.autoretry_for">
<code class="descclassname">Task.</code><code class="descname">autoretry_for</code><a class="headerlink" href="#Task.autoretry_for" title="Permalink to this definition">¶</a></dt>
<dd><p>A list/tuple of exception classes. If any of these exceptions are raised
during the execution of the task, the task will automatically be retried.
By default, no exceptions will be autoretried.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.retry_kwargs">
<code class="descclassname">Task.</code><code class="descname">retry_kwargs</code><a class="headerlink" href="#Task.retry_kwargs" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary. Use this to customize how autoretries are executed.
Note that if you use the exponential backoff options below, the <cite>countdown</cite>
task option will be determined by Celery’s autoretry system, and any
<cite>countdown</cite> included in this dictionary will be ignored.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.retry_backoff">
<code class="descclassname">Task.</code><code class="descname">retry_backoff</code><a class="headerlink" href="#Task.retry_backoff" title="Permalink to this definition">¶</a></dt>
<dd><p>A boolean, or a number. If this option is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, autoretries
will be delayed following the rules of <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a>. The first
retry will have a delay of 1 second, the second retry will have a delay
of 2 seconds, the third will delay 4 seconds, the fourth will delay 8
seconds, and so on. (However, this delay value is modified by
<a class="reference internal" href="#Task.retry_jitter" title="Task.retry_jitter"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_jitter</span></code></a>, if it is enabled.)
If this option is set to a number, it is used as a
delay factor. For example, if this option is set to <code class="docutils literal notranslate"><span class="pre">3</span></code>, the first retry
will delay 3 seconds, the second will delay 6 seconds, the third will
delay 12 seconds, the fourth will delay 24 seconds, and so on. By default,
this option is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, and autoretries will not be delayed.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.retry_backoff_max">
<code class="descclassname">Task.</code><code class="descname">retry_backoff_max</code><a class="headerlink" href="#Task.retry_backoff_max" title="Permalink to this definition">¶</a></dt>
<dd><p>A number. If <code class="docutils literal notranslate"><span class="pre">retry_backoff</span></code> is enabled, this option will set a maximum
delay in seconds between task autoretries. By default, this option is set to <code class="docutils literal notranslate"><span class="pre">600</span></code>,
which is 10 minutes.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.retry_jitter">
<code class="descclassname">Task.</code><code class="descname">retry_jitter</code><a class="headerlink" href="#Task.retry_jitter" title="Permalink to this definition">¶</a></dt>
<dd><p>A boolean. <a class="reference external" href="https://en.wikipedia.org/wiki/Jitter">Jitter</a> is used to introduce randomness into
exponential backoff delays, to prevent all tasks in the queue from being
executed simultaneously. If this option is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the delay
value calculated by <a class="reference internal" href="#Task.retry_backoff" title="Task.retry_backoff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_backoff</span></code></a> is treated as a maximum,
and the actual delay value will be a random number between zero and that
maximum. By default, this option is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</dd></dl>

</div>
</div>
<div class="section" id="list-of-options">
<span id="task-options"></span><h2><a class="toc-backref" href="#id10">List of Options</a><a class="headerlink" href="#list-of-options" title="Permalink to this headline">¶</a></h2>
<p>The task decorator can take a number of options that change the way
the task behaves, for example you can set the rate limit for a task
using the <code class="xref py py-attr docutils literal notranslate"><span class="pre">rate_limit</span></code> option.</p>
<p>Any keyword argument passed to the task decorator will actually be set
as an attribute of the resulting task class, and this is a list
of the built-in attributes.</p>
<div class="section" id="general">
<h3>General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h3>
<span class="target" id="task-general-options"></span><dl class="attribute">
<dt id="Task.name">
<code class="descclassname">Task.</code><code class="descname">name</code><a class="headerlink" href="#Task.name" title="Permalink to this definition">¶</a></dt>
<dd><p>The name the task is registered as.</p>
<p>You can set this name manually, or a name will be
automatically generated using the module and class name.</p>
<p>See also <a class="reference internal" href="#task-names"><span class="std std-ref">Names</span></a>.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.request">
<code class="descclassname">Task.</code><code class="descname">request</code><a class="headerlink" href="#Task.request" title="Permalink to this definition">¶</a></dt>
<dd><p>If the task is being executed this will contain information
about the current request. Thread local storage is used.</p>
<p>See <a class="reference internal" href="#task-request-info"><span class="std std-ref">Task Request</span></a>.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.max_retries">
<code class="descclassname">Task.</code><code class="descname">max_retries</code><a class="headerlink" href="#Task.max_retries" title="Permalink to this definition">¶</a></dt>
<dd><p>Only applies if the task calls <code class="docutils literal notranslate"><span class="pre">self.retry</span></code> or if the task is decorated
with the <a class="reference internal" href="#task-autoretry"><span class="std std-ref">autoretry_for</span></a> argument.</p>
<p>The maximum number of attempted retries before giving up.
If the number of retries exceeds this value a <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.MaxRetriesExceededError" title="celery.exceptions.MaxRetriesExceededError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a>
exception will be raised.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You have to call <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a>
manually, as it won’t automatically retry on exception..</p>
</div>
<p>The default is <code class="docutils literal notranslate"><span class="pre">3</span></code>.
A value of <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> will disable the retry limit and the
task will retry forever until it succeeds.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.throws">
<code class="descclassname">Task.</code><code class="descname">throws</code><a class="headerlink" href="#Task.throws" title="Permalink to this definition">¶</a></dt>
<dd><p>Optional tuple of expected error classes that shouldn’t be regarded
as an actual error.</p>
<p>Errors in this list will be reported as a failure to the result backend,
but the worker won’t log the event as an error, and no traceback will
be included.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">throws</span><span class="o">=</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">HttpNotFound</span><span class="p">)):</span>
<span class="k">def</span> <span class="nf">get_foo</span><span class="p">():</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>Error types:</p>
<ul>
<li><p class="first">Expected errors (in <code class="docutils literal notranslate"><span class="pre">Task.throws</span></code>)</p>
<blockquote>
<div><p>Logged with severity <code class="docutils literal notranslate"><span class="pre">INFO</span></code>, traceback excluded.</p>
</div></blockquote>
</li>
<li><p class="first">Unexpected errors</p>
<blockquote>
<div><p>Logged with severity <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, with traceback included.</p>
</div></blockquote>
</li>
</ul>
</dd></dl>

<dl class="attribute">
<dt id="Task.default_retry_delay">
<code class="descclassname">Task.</code><code class="descname">default_retry_delay</code><a class="headerlink" href="#Task.default_retry_delay" title="Permalink to this definition">¶</a></dt>
<dd><p>Default time in seconds before a retry of the task
should be executed. Can be either <a class="reference external" href="https://docs.python.org/dev/library/functions.html#int" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> or <a class="reference external" href="https://docs.python.org/dev/library/functions.html#float" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a>.
Default is a three minute delay.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.rate_limit">
<code class="descclassname">Task.</code><code class="descname">rate_limit</code><a class="headerlink" href="#Task.rate_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the rate limit for this task type (limits the number of tasks
that can be run in a given time frame). Tasks will still complete when
a rate limit is in effect, but it may take some time before it’s allowed to
start.</p>
<p>If this is <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> no rate limit is in effect.
If it is an integer or float, it is interpreted as “tasks per second”.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <cite>“/s”</cite>, <cite>“/m”</cite> or <cite>“/h”</cite> to the value. Tasks will be evenly
distributed over the specified time frame.</p>
<p>Example: <cite>“100/m”</cite> (hundred tasks a minute). This will enforce a minimum
delay of 600ms between starting two tasks on the same worker instance.</p>
<p>Default is the <a class="reference internal" href="configuration.html#std:setting-task_default_rate_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_default_rate_limit</span></code></a> setting:
if not specified means rate limiting for tasks is disabled by default.</p>
<p>Note that this is a <em>per worker instance</em> rate limit, and not a global
rate limit. To enforce a global rate limit (e.g., for an API with a
maximum number of  requests per second), you must restrict to a given
queue.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.time_limit">
<code class="descclassname">Task.</code><code class="descname">time_limit</code><a class="headerlink" href="#Task.time_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>The hard time limit, in seconds, for this task.
When not set the workers default is used.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.soft_time_limit">
<code class="descclassname">Task.</code><code class="descname">soft_time_limit</code><a class="headerlink" href="#Task.soft_time_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>The soft time limit for this task.
When not set the workers default is used.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.ignore_result">
<code class="descclassname">Task.</code><code class="descname">ignore_result</code><a class="headerlink" href="#Task.ignore_result" title="Permalink to this definition">¶</a></dt>
<dd><p>Don’t store task state. Note that this means you can’t use
<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> to check if the task is ready,
or get its return value.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.store_errors_even_if_ignored">
<code class="descclassname">Task.</code><code class="descname">store_errors_even_if_ignored</code><a class="headerlink" href="#Task.store_errors_even_if_ignored" title="Permalink to this definition">¶</a></dt>
<dd><p>If <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>, errors will be stored even if the task is configured
to ignore results.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.serializer">
<code class="descclassname">Task.</code><code class="descname">serializer</code><a class="headerlink" href="#Task.serializer" title="Permalink to this definition">¶</a></dt>
<dd><p>A string identifying the default serialization
method to use. Defaults to the <a class="reference internal" href="configuration.html#std:setting-task_serializer"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_serializer</span></code></a>
setting. Can be <cite>pickle</cite>, <cite>json</cite>, <cite>yaml</cite>, or any custom
serialization methods that have been registered with
<code class="xref py py-mod docutils literal notranslate"><span class="pre">kombu.serialization.registry</span></code>.</p>
<p>Please see <a class="reference internal" href="calling.html#calling-serializers"><span class="std std-ref">Serializers</span></a> for more information.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.compression">
<code class="descclassname">Task.</code><code class="descname">compression</code><a class="headerlink" href="#Task.compression" title="Permalink to this definition">¶</a></dt>
<dd><p>A string identifying the default compression scheme to use.</p>
<p>Defaults to the <a class="reference internal" href="configuration.html#std:setting-task_compression"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_compression</span></code></a> setting.
Can be <cite>gzip</cite>, or <cite>bzip2</cite>, or any custom compression schemes
that have been registered with the <a class="reference external" href="http://kombu.readthedocs.io/en/master/reference/kombu.compression.html#module-kombu.compression" title="(in Kombu v4.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">kombu.compression</span></code></a> registry.</p>
<p>Please see <a class="reference internal" href="calling.html#calling-compression"><span class="std std-ref">Compression</span></a> for more information.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.backend">
<code class="descclassname">Task.</code><code class="descname">backend</code><a class="headerlink" href="#Task.backend" title="Permalink to this definition">¶</a></dt>
<dd><p>The result store backend to use for this task. An instance of one of the
backend classes in <cite>celery.backends</cite>. Defaults to <cite>app.backend</cite>,
defined by the <a class="reference internal" href="configuration.html#std:setting-result_backend"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_backend</span></code></a> setting.</p>
</dd></dl>

<dl class="attribute">
<dt id="Task.acks_late">
<code class="descclassname">Task.</code><code class="descname">acks_late</code><a class="headerlink" href="#Task.acks_late" title="Permalink to this definition">¶</a></dt>
<dd><p>If set to <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> messages for this task will be acknowledged
<strong>after</strong> the task has been executed, not <em>just before</em> (the default
behavior).</p>
<p>Note: This means the task may be executed multiple times should the worker
crash in the middle of execution.  Make sure your tasks are
<a class="reference internal" href="../glossary.html#term-idempotent"><span class="xref std std-term">idempotent</span></a>.</p>
<p>The global default can be overridden by the <a class="reference internal" href="configuration.html#std:setting-task_acks_late"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_acks_late</span></code></a>
setting.</p>
</dd></dl>

<span class="target" id="task-track-started"></span><dl class="attribute">
<dt id="Task.track_started">
<code class="descclassname">Task.</code><code class="descname">track_started</code><a class="headerlink" href="#Task.track_started" title="Permalink to this definition">¶</a></dt>
<dd><p>If <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> the task will report its status as “started”
when the task is executed by a worker.
The default value is <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code> as the normal behavior is to not
report that level of granularity. Tasks are either pending, finished,
or waiting to be retried. Having a “started” status can be useful for
when there are long running tasks and there’s a need to report what
task is currently running.</p>
<p>The host name and process id of the worker executing the task
will be available in the state meta-data (e.g., <cite>result.info[‘pid’]</cite>)</p>
<p>The global default can be overridden by the
<a class="reference internal" href="configuration.html#std:setting-task_track_started"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_track_started</span></code></a> setting.</p>
</dd></dl>

<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The API reference for <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task" title="celery.app.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a>.</p>
</div>
</div>
</div>
<div class="section" id="states">
<span id="task-states"></span><h2><a class="toc-backref" href="#id11">States</a><a class="headerlink" href="#states" title="Permalink to this headline">¶</a></h2>
<p>Celery can keep track of the tasks current state. The state also contains the
result of a successful task, or the exception and traceback information of a
failed task.</p>
<p>There are several <em>result backends</em> to choose from, and they all have
different strengths and weaknesses (see <a class="reference internal" href="#task-result-backends"><span class="std std-ref">Result Backends</span></a>).</p>
<p>During its lifetime a task will transition through several possible states,
and each state may have arbitrary meta-data attached to it. When a task
moves into a new state the previous state is
forgotten about, but some transitions can be deducted, (e.g., a task now
in the <code class="xref std std-state docutils literal notranslate"><span class="pre">FAILED</span></code> state, is implied to have been in the
<a class="reference internal" href="#std:state-STARTED"><code class="xref std std-state docutils literal notranslate"><span class="pre">STARTED</span></code></a> state at some point).</p>
<p>There are also sets of states, like the set of
<code class="xref std std-state docutils literal notranslate"><span class="pre">FAILURE_STATES</span></code>, and the set of <a class="reference internal" href="../reference/celery.states.html#std:state-READY_STATES"><code class="xref std std-state docutils literal notranslate"><span class="pre">READY_STATES</span></code></a>.</p>
<p>The client uses the membership of these sets to decide whether
the exception should be re-raised (<a class="reference internal" href="../reference/celery.states.html#std:state-PROPAGATE_STATES"><code class="xref std std-state docutils literal notranslate"><span class="pre">PROPAGATE_STATES</span></code></a>), or whether
the state can be cached (it can if the task is ready).</p>
<p>You can also define <a class="reference internal" href="#custom-states"><span class="std std-ref">Custom states</span></a>.</p>
<div class="section" id="result-backends">
<span id="task-result-backends"></span><h3>Result Backends<a class="headerlink" href="#result-backends" title="Permalink to this headline">¶</a></h3>
<p>If you want to keep track of tasks or need the return values, then Celery
must store or send the states somewhere so that they can be retrieved later.
There are several built-in result backends to choose from: SQLAlchemy/Django ORM,
Memcached, RabbitMQ/QPid (<code class="docutils literal notranslate"><span class="pre">rpc</span></code>), and Redis – or you can define your own.</p>
<p>No backend works well for every use case.
You should read about the strengths and weaknesses of each backend, and choose
the most appropriate for your needs.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="configuration.html#conf-result-backend"><span class="std std-ref">Task result backend settings</span></a></p>
</div>
<div class="section" id="rpc-result-backend-rabbitmq-qpid">
<h4>RPC Result Backend (RabbitMQ/QPid)<a class="headerlink" href="#rpc-result-backend-rabbitmq-qpid" title="Permalink to this headline">¶</a></h4>
<p>The RPC result backend (<cite>rpc://</cite>) is special as it doesn’t actually <em>store</em>
the states, but rather sends them as messages. This is an important difference as it
means that a result <em>can only be retrieved once</em>, and <em>only by the client
that initiated the task</em>. Two different processes can’t wait for the same result.</p>
<p>Even with that limitation, it is an excellent choice if you need to receive
state changes in real-time. Using messaging means the client doesn’t have to
poll for new states.</p>
<p>The messages are transient (non-persistent) by default, so the results will
disappear if the broker restarts. You can configure the result backend to send
persistent messages using the <a class="reference internal" href="configuration.html#std:setting-result_persistent"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_persistent</span></code></a> setting.</p>
</div>
<div class="section" id="database-result-backend">
<h4>Database Result Backend<a class="headerlink" href="#database-result-backend" title="Permalink to this headline">¶</a></h4>
<p>Keeping state in the database can be convenient for many, especially for
web applications with a database already in place, but it also comes with
limitations.</p>
<ul>
<li><p class="first">Polling the database for new states is expensive, and so you should
increase the polling intervals of operations, such as <cite>result.get()</cite>.</p>
</li>
<li><p class="first">Some databases use a default transaction isolation level that
isn’t suitable for polling tables for changes.</p>
<p>In MySQL the default transaction isolation level is <cite>REPEATABLE-READ</cite>:
meaning the transaction won’t see changes made by other transactions until
the current transaction is committed.</p>
<p>Changing that to the <cite>READ-COMMITTED</cite> isolation level is recommended.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="built-in-states">
<span id="task-builtin-states"></span><h3>Built-in States<a class="headerlink" href="#built-in-states" title="Permalink to this headline">¶</a></h3>
<div class="section" id="pending">
<span id="std:state-PENDING"></span><h4>PENDING<a class="headerlink" href="#pending" title="Permalink to this headline">¶</a></h4>
<p>Task is waiting for execution or unknown.
Any task id that’s not known is implied to be in the pending state.</p>
</div>
<div class="section" id="started">
<span id="std:state-STARTED"></span><h4>STARTED<a class="headerlink" href="#started" title="Permalink to this headline">¶</a></h4>
<p>Task has been started.
Not reported by default, to enable please see <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.track_started" title="celery.app.task.Task.track_started"><code class="xref py py-attr docutils literal notranslate"><span class="pre">app.Task.track_started</span></code></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">meta-data:</th><td class="field-body"><cite>pid</cite> and <cite>hostname</cite> of the worker process executing
the task.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="success">
<span id="std:state-SUCCESS"></span><h4>SUCCESS<a class="headerlink" href="#success" title="Permalink to this headline">¶</a></h4>
<p>Task has been successfully executed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">meta-data:</th><td class="field-body"><cite>result</cite> contains the return value of the task.</td>
</tr>
<tr class="field-even field"><th class="field-name">propagates:</th><td class="field-body">Yes</td>
</tr>
<tr class="field-odd field"><th class="field-name">ready:</th><td class="field-body">Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="failure">
<span id="std:state-FAILURE"></span><h4>FAILURE<a class="headerlink" href="#failure" title="Permalink to this headline">¶</a></h4>
<p>Task execution resulted in failure.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">meta-data:</th><td class="field-body"><cite>result</cite> contains the exception occurred, and <cite>traceback</cite>
contains the backtrace of the stack at the point when the
exception was raised.</td>
</tr>
<tr class="field-even field"><th class="field-name">propagates:</th><td class="field-body">Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="retry">
<span id="std:state-RETRY"></span><h4>RETRY<a class="headerlink" href="#retry" title="Permalink to this headline">¶</a></h4>
<p>Task is being retried.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">meta-data:</th><td class="field-body"><cite>result</cite> contains the exception that caused the retry,
and <cite>traceback</cite> contains the backtrace of the stack at the point
when the exceptions was raised.</td>
</tr>
<tr class="field-even field"><th class="field-name">propagates:</th><td class="field-body">No</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="revoked">
<span id="std:state-REVOKED"></span><h4>REVOKED<a class="headerlink" href="#revoked" title="Permalink to this headline">¶</a></h4>
<p>Task has been revoked.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">propagates:</th><td class="field-body">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="custom-states">
<span id="id1"></span><h3>Custom states<a class="headerlink" href="#custom-states" title="Permalink to this headline">¶</a></h3>
<p>You can easily define your own states, all you need is a unique name.
The name of the state is usually an uppercase string. As an example
you could have a look at the <code class="xref py py-mod docutils literal notranslate"><span class="pre">abortable</span> <span class="pre">tasks</span></code>
which defines a custom <code class="xref std std-state docutils literal notranslate"><span class="pre">ABORTED</span></code> state.</p>
<p>Use <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.update_state" title="celery.app.task.Task.update_state"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update_state()</span></code></a> to update a task’s state:.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">upload_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">called_directly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;PROGRESS&#39;</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)})</span>
</pre></div>
</div>
<p>Here I created the state <cite>“PROGRESS”</cite>, telling any application
aware of this state that the task is currently in progress, and also where
it is in the process by having <cite>current</cite> and <cite>total</cite> counts as part of the
state meta-data. This can then be used to create progress bars for example.</p>
</div>
<div class="section" id="creating-pickleable-exceptions">
<span id="pickling-exceptions"></span><h3>Creating pickleable exceptions<a class="headerlink" href="#creating-pickleable-exceptions" title="Permalink to this headline">¶</a></h3>
<p>A rarely known Python fact is that exceptions must conform to some
simple rules to support being serialized by the pickle module.</p>
<p>Tasks that raise exceptions that aren’t pickleable won’t work
properly when Pickle is used as the serializer.</p>
<p>To make sure that your exceptions are pickleable the exception
<em>MUST</em> provide the original arguments it was instantiated
with in its <code class="docutils literal notranslate"><span class="pre">.args</span></code> attribute. The simplest way
to ensure this is to have the exception call <code class="docutils literal notranslate"><span class="pre">Exception.__init__</span></code>.</p>
<p>Let’s look at some examples that work, and one that doesn’t:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># OK:</span>
<span class="k">class</span> <span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># BAD:</span>
<span class="k">class</span> <span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>

<span class="c1"># OK:</span>
<span class="k">class</span> <span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>  <span class="c1"># &lt;-- REQUIRED</span>
</pre></div>
</div>
<p>So the rule is:
For any exception that supports custom arguments <code class="docutils literal notranslate"><span class="pre">*args</span></code>,
<code class="docutils literal notranslate"><span class="pre">Exception.__init__(self,</span> <span class="pre">*args)</span></code> must be used.</p>
<p>There’s no special support for <em>keyword arguments</em>, so if you
want to preserve keyword arguments when the exception is unpickled
you have to pass them as regular args:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HttpError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="semipredicates">
<span id="task-semipredicates"></span><h2><a class="toc-backref" href="#id12">Semipredicates</a><a class="headerlink" href="#semipredicates" title="Permalink to this headline">¶</a></h2>
<p>The worker wraps the task in a tracing function that records the final
state of the task. There are a number of exceptions that can be used to
signal this function to change how it treats the return of the task.</p>
<div class="section" id="ignore">
<span id="task-semipred-ignore"></span><h3>Ignore<a class="headerlink" href="#ignore" title="Permalink to this headline">¶</a></h3>
<p>The task may raise <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Ignore" title="celery.exceptions.Ignore"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Ignore</span></code></a> to force the worker to ignore the
task. This means that no state will be recorded for the task, but the
message is still acknowledged (removed from queue).</p>
<p>This can be used if you want to implement custom revoke-like
functionality, or manually store the result of a task.</p>
<p>Example keeping revoked tasks in a Redis set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="n">Ignore</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">some_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">redis</span><span class="o">.</span><span class="n">ismember</span><span class="p">(</span><span class="s1">&#39;tasks.revoked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</pre></div>
</div>
<p>Example that stores results manually:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">states</span>
<span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="n">Ignore</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_tweets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">called_directly</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">timeline</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="reject">
<span id="task-semipred-reject"></span><h3>Reject<a class="headerlink" href="#reject" title="Permalink to this headline">¶</a></h3>
<p>The task may raise <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Reject" title="celery.exceptions.Reject"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Reject</span></code></a> to reject the task message using
AMQPs <code class="docutils literal notranslate"><span class="pre">basic_reject</span></code> method. This won’t have any effect unless
<a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Task.acks_late</span></code></a> is enabled.</p>
<p>Rejecting a message has the same effect as acking it, but some
brokers may implement additional functionality that can be used.
For example RabbitMQ supports the concept of <a class="reference external" href="http://www.rabbitmq.com/dlx.html">Dead Letter Exchanges</a>
where a queue can be configured to use a dead letter exchange that rejected
messages are redelivered to.</p>
<p>Reject can also be used to re-queue messages, but please be very careful
when using this as it can easily result in an infinite message loop.</p>
<p>Example using reject when a task causes an out of memory condition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="n">Reject</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">acks_late</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">render_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">renderer</span><span class="o">.</span><span class="n">render_scene</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

    <span class="c1"># if the file is too big to fit in memory</span>
    <span class="c1"># we reject it so that it&#39;s redelivered to the dead letter exchange</span>
    <span class="c1"># and we can manually inspect the situation.</span>
    <span class="k">except</span> <span class="ne">MemoryError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOMEM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># For any other error we retry after 10 seconds.</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Example re-queuing the message:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="n">Reject</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">acks_late</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">requeues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">&#39;redelivered&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="s1">&#39;no reason&#39;</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;received two times&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Consult your broker documentation for more details about the <code class="docutils literal notranslate"><span class="pre">basic_reject</span></code>
method.</p>
</div>
<div class="section" id="task-semipred-retry">
<span id="id2"></span><h3>Retry<a class="headerlink" href="#task-semipred-retry" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Retry" title="celery.exceptions.Retry"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Retry</span></code></a> exception is raised by the <code class="docutils literal notranslate"><span class="pre">Task.retry</span></code> method
to tell the worker that the task is being retried.</p>
</div>
</div>
<div class="section" id="custom-task-classes">
<span id="task-custom-classes"></span><h2><a class="toc-backref" href="#id13">Custom task classes</a><a class="headerlink" href="#custom-task-classes" title="Permalink to this headline">¶</a></h2>
<p>All tasks inherit from the <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task" title="celery.app.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.Task</span></code></a> class.
The <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.run" title="celery.app.task.Task.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run()</span></code></a> method becomes the task body.</p>
<p>As an example, the following code,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>will do roughly this behind the scenes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_AddTask</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">_AddTask</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="instantiation">
<h3>Instantiation<a class="headerlink" href="#instantiation" title="Permalink to this headline">¶</a></h3>
<p>A task is <strong>not</strong> instantiated for every request, but is registered
in the task registry as a global instance.</p>
<p>This means that the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> constructor will only be called
once per process, and that the task class is semantically closer to an
Actor.</p>
<p>If you have a task,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">NaiveAuthenticateServer</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;george&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
<p>And you route every request to the same process, then it
will keep state between requests.</p>
<p>This can also be useful to cache resources,
For example, a base Task class that caches a database connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">DatabaseTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
</pre></div>
</div>
<p>that can be added to tasks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">DatabaseTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_rows</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">process_rows</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">db</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">process_rows</span></code> task will then
always stay the same in each process.</p>
</div>
<div class="section" id="handlers">
<h3>Handlers<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="after_return">
<code class="descname">after_return</code><span class="sig-paren">(</span><em>self</em>, <em>status</em>, <em>retval</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em>, <em>einfo</em><span class="sig-paren">)</span><a class="headerlink" href="#after_return" title="Permalink to this definition">¶</a></dt>
<dd><p>Handler called after the task returns.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>status</strong> – Current task state.</li>
<li><strong>retval</strong> – Task return value/exception.</li>
<li><strong>task_id</strong> – Unique id of the task.</li>
<li><strong>args</strong> – Original arguments for the task that returned.</li>
<li><strong>kwargs</strong> – Original keyword arguments for the task
that returned.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Keyword Arguments:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><p class="first last"><strong>einfo</strong> – <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
instance, containing the traceback (if any).</p>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="method">
<dt id="on_failure">
<code class="descname">on_failure</code><span class="sig-paren">(</span><em>self</em>, <em>exc</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em>, <em>einfo</em><span class="sig-paren">)</span><a class="headerlink" href="#on_failure" title="Permalink to this definition">¶</a></dt>
<dd><p>This is run by the worker when the task fails.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>exc</strong> – The exception raised by the task.</li>
<li><strong>task_id</strong> – Unique id of the failed task.</li>
<li><strong>args</strong> – Original arguments for the task that failed.</li>
<li><strong>kwargs</strong> – Original keyword arguments for the task
that failed.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Keyword Arguments:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><p class="first last"><strong>einfo</strong> – <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
instance, containing the traceback.</p>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="method">
<dt id="on_retry">
<code class="descname">on_retry</code><span class="sig-paren">(</span><em>self</em>, <em>exc</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em>, <em>einfo</em><span class="sig-paren">)</span><a class="headerlink" href="#on_retry" title="Permalink to this definition">¶</a></dt>
<dd><p>This is run by the worker when the task is to be retried.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>exc</strong> – The exception sent to <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a>.</li>
<li><strong>task_id</strong> – Unique id of the retried task.</li>
<li><strong>args</strong> – Original arguments for the retried task.</li>
<li><strong>kwargs</strong> – Original keyword arguments for the retried task.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Keyword Arguments:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><p class="first last"><strong>einfo</strong> – <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
instance, containing the traceback.</p>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="method">
<dt id="on_success">
<code class="descname">on_success</code><span class="sig-paren">(</span><em>self</em>, <em>retval</em>, <em>task_id</em>, <em>args</em>, <em>kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#on_success" title="Permalink to this definition">¶</a></dt>
<dd><p>Run by the worker if the task executes successfully.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>retval</strong> – The return value of the task.</li>
<li><strong>task_id</strong> – Unique id of the executed task.</li>
<li><strong>args</strong> – Original arguments for the executed task.</li>
<li><strong>kwargs</strong> – Original keyword arguments for the executed task.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The return value of this handler is ignored.</p>
</dd></dl>

</div>
<div class="section" id="requests-and-custom-requests">
<span id="task-requests-and-custom-requests"></span><h3>Requests and custom requests<a class="headerlink" href="#requests-and-custom-requests" title="Permalink to this headline">¶</a></h3>
<p>Upon receiving a message to run a task, the <a class="reference internal" href="workers.html#guide-workers"><span class="std std-ref">worker</span></a>
creates a <a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> to represent such
demand.</p>
<p>Custom task classes may override which request class to use by changing the
attribute <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.Request" title="celery.app.task.Task.Request"><code class="xref py py-attr docutils literal notranslate"><span class="pre">celery.app.task.Task.Request</span></code></a>.  You may either assign the
custom request class itself, or its fully qualified name.</p>
<p>The request has several responsibilities.  Custom request classes should cover
them all – they are responsible to actually run and trace the task.  We
strongly recommend to inherit from <a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.worker.request.Request</span></code></a>.</p>
<p>When using the <a class="reference internal" href="workers.html#worker-concurrency"><span class="std std-ref">pre-forking worker</span></a>, the methods
<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request.on_timeout" title="celery.worker.request.Request.on_timeout"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_timeout()</span></code></a> and
<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request.on_failure" title="celery.worker.request.Request.on_failure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_failure()</span></code></a> are executed in the main
worker process.  An application may leverage such facility to detect failures
which are not detected using <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.on_failure" title="celery.app.task.Task.on_failure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">celery.app.task.Task.on_failure()</span></code></a>.</p>
<p>As an example, the following custom request detects and logs hard time
limits, and other failures.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">celery.worker.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;my.package&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="s1">&#39;A minimal custom request to log failures and hard time limits.&#39;</span>

    <span class="k">def</span> <span class="nf">on_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_timeout</span><span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">soft</span><span class="p">:</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
               <span class="s1">&#39;A hard timeout was enforced for task </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span>
           <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">,</span> <span class="n">send_failed_event</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">return_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span>
            <span class="n">exc_info</span><span class="p">,</span>
            <span class="n">send_failed_event</span><span class="o">=</span><span class="n">send_failed_event</span><span class="p">,</span>
            <span class="n">return_ok</span><span class="o">=</span><span class="n">return_ok</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Failure detected for task </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">Request</span> <span class="o">=</span> <span class="n">MyRequest</span>  <span class="c1"># you can use a FQN &#39;my.package:MyRequest&#39;</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">some_longrunning_task</span><span class="p">():</span>
    <span class="c1"># use your imagination</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-it-works">
<span id="task-how-they-work"></span><h2><a class="toc-backref" href="#id14">How it works</a><a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>Here come the technical details. This part isn’t something you need to know,
but you may be interested.</p>
<p>All defined tasks are listed in a registry. The registry contains
a list of task names and their task classes. You can investigate this registry
yourself:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.celery</span> <span class="kn">import</span> <span class="n">app</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span>
<span class="go">{&#39;celery.chord_unlock&#39;:</span>
<span class="go">    &lt;@task: celery.chord_unlock&gt;,</span>
<span class="go"> &#39;celery.backend_cleanup&#39;:</span>
<span class="go">    &lt;@task: celery.backend_cleanup&gt;,</span>
<span class="go"> &#39;celery.chord&#39;:</span>
<span class="go">    &lt;@task: celery.chord&gt;}</span>
</pre></div>
</div>
<p>This is the list of tasks built-in to Celery. Note that tasks
will only be registered when the module they’re defined in is imported.</p>
<p>The default loader imports any modules listed in the
<a class="reference internal" href="configuration.html#std:setting-imports"><code class="xref std std-setting docutils literal notranslate"><span class="pre">imports</span></code></a> setting.</p>
<p>The <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> decorator is responsible for registering your task
in the applications task registry.</p>
<p>When tasks are sent, no actual function code is sent with it, just the name
of the task to execute. When the worker then receives the message it can look
up the name in its task registry to find the execution code.</p>
<p>This means that your workers should always be updated with the same software
as the client. This is a drawback, but the alternative is a technical
challenge that’s yet to be solved.</p>
</div>
<div class="section" id="tips-and-best-practices">
<span id="task-best-practices"></span><h2><a class="toc-backref" href="#id15">Tips and Best Practices</a><a class="headerlink" href="#tips-and-best-practices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ignore-results-you-don-t-want">
<span id="task-ignore-results"></span><h3>Ignore results you don’t want<a class="headerlink" href="#ignore-results-you-don-t-want" title="Permalink to this headline">¶</a></h3>
<p>If you don’t care about the results of a task, be sure to set the
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.ignore_result" title="celery.app.task.Task.ignore_result"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ignore_result</span></code></a> option, as storing results
wastes time and resources.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mytask</span><span class="p">():</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>Results can even be disabled globally using the <a class="reference internal" href="configuration.html#std:setting-task_ignore_result"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_ignore_result</span></code></a>
setting.</p>
</div>
<div class="section" id="more-optimization-tips">
<h3>More optimization tips<a class="headerlink" href="#more-optimization-tips" title="Permalink to this headline">¶</a></h3>
<p>You find additional optimization tips in the
<a class="reference internal" href="optimizing.html#guide-optimizing"><span class="std std-ref">Optimizing Guide</span></a>.</p>
</div>
<div class="section" id="avoid-launching-synchronous-subtasks">
<span id="task-synchronous-subtasks"></span><h3>Avoid launching synchronous subtasks<a class="headerlink" href="#avoid-launching-synchronous-subtasks" title="Permalink to this headline">¶</a></h3>
<p>Having a task wait for the result of another task is really inefficient,
and may even cause a deadlock if the worker pool is exhausted.</p>
<p>Make your design asynchronous instead, for example by using <em>callbacks</em>.</p>
<p><strong>Bad</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Good</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c1"># fetch_page -&gt; parse_page -&gt; store_page</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">|</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">store_page_info</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">chain</span><span class="p">()</span>

<span class="nd">@app.task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app.task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>Here I instead created a chain of tasks by linking together
different <a class="reference internal" href="../reference/celery.html#celery.signature" title="celery.signature"><code class="xref py py-func docutils literal notranslate"><span class="pre">signature()</span></code></a>’s.
You can read about chains and other powerful constructs
at <a class="reference internal" href="../getting-started/next-steps.html#designing-workflows"><span class="std std-ref">Canvas: Designing Work-flows</span></a>.</p>
<p>By default celery will not enable you to run tasks within task synchronously
in rare or extreme cases you might have to do so.
<strong>WARNING</strong>:
enabling subtasks run synchronously is not recommended!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">disable_sync_subtasks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">disable_sync_subtasks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="performance-and-strategies">
<span id="task-performance-and-strategies"></span><h2><a class="toc-backref" href="#id16">Performance and Strategies</a><a class="headerlink" href="#performance-and-strategies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="granularity">
<span id="task-granularity"></span><h3>Granularity<a class="headerlink" href="#granularity" title="Permalink to this headline">¶</a></h3>
<p>The task granularity is the amount of computation needed by each subtask.
In general it is better to split the problem up into many small tasks rather
than have a few long running tasks.</p>
<p>With smaller tasks you can process more tasks in parallel and the tasks
won’t run long enough to block the worker from processing other waiting tasks.</p>
<p>However, executing a task does have overhead. A message needs to be sent, data
may not be local, etc. So if the tasks are too fine-grained the
overhead added probably removes any benefit.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The book <a class="reference external" href="http://oreilly.com/catalog/9780596521547">Art of Concurrency</a> has a section dedicated to the topic
of task granularity <a class="reference internal" href="#aoc1" id="id3">[AOC1]</a>.</p>
</div>
<table class="docutils citation" frame="void" id="aoc1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[AOC1]</a></td><td>Breshears, Clay. Section 2.2.1, “The Art of Concurrency”.
O’Reilly Media, Inc. May 15, 2009. ISBN-13 978-0-596-52153-0.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="data-locality">
<span id="task-data-locality"></span><h3>Data locality<a class="headerlink" href="#data-locality" title="Permalink to this headline">¶</a></h3>
<p>The worker processing the task should be as close to the data as
possible. The best would be to have a copy in memory, the worst would be a
full transfer from another continent.</p>
<p>If the data is far away, you could try to run another worker at location, or
if that’s not possible - cache often used data, or preload data you know
is going to be used.</p>
<p>The easiest way to share data between workers is to use a distributed cache
system, like <a class="reference external" href="http://memcached.org/">memcached</a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The paper <a class="reference external" href="http://research.microsoft.com/pubs/70001/tr-2003-24.pdf">Distributed Computing Economics</a> by Jim Gray is an excellent
introduction to the topic of data locality.</p>
</div>
</div>
<div class="section" id="state">
<span id="task-state"></span><h3>State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<p>Since celery is a distributed system, you can’t know which process, or
on what machine the task will be executed. You can’t even know if the task will
run in a timely manner.</p>
<p>The ancient async sayings tells us that “asserting the world is the
responsibility of the task”. What this means is that the world view may
have changed since the task was requested, so the task is responsible for
making sure the world is how it should be;  If you have a task
that re-indexes a search engine, and the search engine should only be
re-indexed at maximum every 5 minutes, then it must be the tasks
responsibility to assert that, not the callers.</p>
<p>Another gotcha is Django model objects. They shouldn’t be passed on as
arguments to tasks. It’s almost always better to re-fetch the object from
the database when the task is running instead,  as using old data may lead
to race conditions.</p>
<p>Imagine the following scenario where you have an article and a task
that automatically expands some abbreviations in it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MyCorp&#39;</span><span class="p">,</span> <span class="s1">&#39;My Corporation&#39;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>First, an author creates an article and saves it, then the author
clicks on a button that initiates the abbreviation task:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, the queue is very busy, so the task won’t be run for another 2 minutes.
In the meantime another author makes changes to the article, so
when the task is finally run, the body of the article is reverted to the old
version because the task had the old body in its argument.</p>
<p>Fixing the race condition is easy, just use the article id instead, and
re-fetch the article in the task body:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article_id</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MyCorp&#39;</span><span class="p">,</span> <span class="s1">&#39;My Corporation&#39;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article_id</span><span class="p">)</span>
</pre></div>
</div>
<p>There might even be performance benefits to this approach, as sending large
messages may be expensive.</p>
</div>
<div class="section" id="database-transactions">
<span id="task-database-transactions"></span><h3>Database transactions<a class="headerlink" href="#database-transactions" title="Permalink to this headline">¶</a></h3>
<p>Let’s have a look at another example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="nd">@transaction.commit_on_success</span>
<span class="k">def</span> <span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a Django view creating an article object in the database,
then passing the primary key to a task. It uses the <cite>commit_on_success</cite>
decorator, that will commit the transaction when the view returns, or
roll back if the view raises an exception.</p>
<p>There’s a race condition if the task starts executing
before the transaction has been committed; The database object doesn’t exist
yet!</p>
<p>The solution is to use the <code class="docutils literal notranslate"><span class="pre">on_commit</span></code> callback to launch your celery task
once all transactions have been committed successfully.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.transaction</span> <span class="kn">import</span> <span class="n">on_commit</span>

<span class="k">def</span> <span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">on_commit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">on_commit</span></code> is available in Django 1.9 and above, if you are using a
version prior to that then the <a class="reference external" href="https://github.com/carljm/django-transaction-hooks">django-transaction-hooks</a> library
adds support for this.</p>
</div>
</div>
</div>
<div class="section" id="task-example">
<span id="id4"></span><h2><a class="toc-backref" href="#id17">Example</a><a class="headerlink" href="#task-example" title="Permalink to this headline">¶</a></h2>
<p>Let’s take a real world example: a blog where comments posted need to be
filtered for spam. When the comment is created, the spam filter runs in the
background, so the user doesn’t have to wait for it to finish.</p>
<p>I have a Django blog application allowing comments
on blog posts. I’ll describe parts of the models/views and tasks for this
application.</p>
<div class="section" id="blog-models-py">
<h3><code class="docutils literal notranslate"><span class="pre">blog/models.py</span></code><a class="headerlink" href="#blog-models-py" title="Permalink to this headline">¶</a></h3>
<p>The comment model looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;email address&#39;</span><span class="p">))</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;home page&#39;</span><span class="p">),</span>
                               <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verify_exists</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">))</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Published date&#39;</span><span class="p">),</span>
                                    <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_add_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;spam?&#39;</span><span class="p">),</span>
                                  <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the view where the comment is posted, I first write the comment
to the database, then I launch the spam filter task in the background.</p>
</div>
<div class="section" id="blog-views-py">
<span id="task-example-blog-views"></span><h3><code class="docutils literal notranslate"><span class="pre">blog/views.py</span></code><a class="headerlink" href="#blog-views-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.template.context</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render_to_response</span>

<span class="kn">from</span> <span class="nn">blog</span> <span class="kn">import</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Comment</span>


<span class="k">class</span> <span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>


<span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;comments/create.html&#39;</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
    <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Check spam asynchronously.</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">spam_filter</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">comment_id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">remote_addr</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>To filter spam in comments I use <a class="reference external" href="http://akismet.com/faq/">Akismet</a>, the service
used to filter spam in comments posted to the free blog platform
<cite>Wordpress</cite>. <a class="reference external" href="http://akismet.com/faq/">Akismet</a> is free for personal use, but for commercial use you
need to pay. You have to sign up to their service to get an API key.</p>
<p>To make API calls to <a class="reference external" href="http://akismet.com/faq/">Akismet</a> I use the <a class="reference external" href="http://www.voidspace.org.uk/downloads/akismet.py">akismet.py</a> library written by
<a class="reference external" href="http://www.voidspace.org.uk/">Michael Foord</a>.</p>
</div>
<div class="section" id="blog-tasks-py">
<span id="task-example-blog-tasks"></span><h3><code class="docutils literal notranslate"><span class="pre">blog/tasks.py</span></code><a class="headerlink" href="#blog-tasks-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="kn">from</span> <span class="nn">akismet</span> <span class="kn">import</span> <span class="n">Akismet</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Comment</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>


<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">spam_filter</span><span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">remote_addr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">spam_filter</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running spam filter for comment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">comment_id</span><span class="p">)</span>

    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
    <span class="n">current_domain</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
    <span class="n">akismet</span> <span class="o">=</span> <span class="n">Akismet</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AKISMET_KEY</span><span class="p">,</span> <span class="s1">&#39;http://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">domain</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">akismet</span><span class="o">.</span><span class="n">verify_key</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;Invalid AKISMET_KEY&#39;</span><span class="p">)</span>


    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">akismet</span><span class="o">.</span><span class="n">comment_check</span><span class="p">(</span><span class="n">user_ip</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">,</span>
                        <span class="n">comment_content</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                        <span class="n">comment_author</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">comment_author_email</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_spam</span><span class="p">:</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">is_spam</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">is_spam</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/celery_512.png" alt="Logo"/>
            </a></p><iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>
<div id="donate">
    <b>Please help support this community project with a donation:</b>
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
    <input type="hidden" name="cmd" value="_s-xclick">
    <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----MIIHTwYJKoZIhvcNAQcEoIIHQDCCBzwCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYA2+c723xlntHKQYQR9yn9BEtUhDoUUlnOqhniqvNMWB4k2R0JpVkrNSu5JCbdjNOqDXKHoRfIWe3HXJJMPZBJKFMD5Izprb6xEZlTGaWnlrGXFfkdBaILQQgWYqV0DnuNmtDXCvfYmyu0p1K04wLjAJ1ufnBSP1UaS6BTcoIOOuTELMAkGBSsOAwIaBQAwgcwGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIFg/2qPwa7UCAgah20QLIllcp0VHazYo2C9h8c6gn8MTcTnpW0WFXhz9ylc/i5dCXabkrrLBBfg8NygAuvYRr4k1zdC0AJIgsV/6rSAhehabRvjRDH2EZ8OieqHfIPfkAcTm+JqbS6Z27lXkebYPnJzhkZxW7+ZC6hU/H40JFXChTag8lhqJfZELiOZLWxxilj2mkwlkdMx1YL6lcPAA7ajpAwjsnJYd/9VxLA6MDmcOu+TKgggOHMIIDgzCCAuygAwIBAgIBADANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wHhcNMDQwMjEzMTAxMzE1WhcNMzUwMjEzMTAxMzE1WjCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMFHTt38RMxLXJyO2SmS+Ndl72T7oKJ4u4uw+6awntALWh03PewmIJuzbALScsTS4sZoS1fKciBGoh11gIfHzylvkdNe/hJl66/RGqrj5rFb08sAABNTzDTiqqNpJeBsYs/c2aiGozptX2RlnBktH+SUNpAajW724Nv2Wvhif6sFAgMBAAGjge4wgeswHQYDVR0OBBYEFJaffLvGbxe9WT9S1wob7BDWZJRrMIG7BgNVHSMEgbMwgbCAFJaffLvGbxe9WT9S1wob7BDWZJRroYGUpIGRMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbYIBADAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA4GBAIFfOlaagFrl71+jq6OKidbWFSE+Q4FqROvdgIONth+8kSK//Y/4ihuE4Ymvzn5ceE3S/iBSQQMjyvb+s2TWbQYDwcp129OPIbD9epdr4tJOUNiSojw7BHwYRiPh58S1xGlFgHFXwrEBb3dgNbMUa+u4qectsMAXpVHnD9wIyfmHMYIBmjCCAZYCAQEwgZQwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tAgEAMAkGBSsOAwIaBQCgXTAYBgkqhkiG9w0BCQMxCwYJKoZIhvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0xNTEyMTAxOTEzMzBaMCMGCSqGSIb3DQEJBDEWBBTUno4gI/mmaVaGVpgB/CWwQd3DeDANBgkqhkiG9w0BAQEFAASBgFmZ1j1Ss/FNl/JRIOakhBJEdm2KGLH0d2ewwTYIgIkEKSdc5Rg2/2xFS/dglcs5Te3R2GzaqjGlNSKldsk/MgZP/BudpHAASQ09hrfDy5TaBlRRl1Yu0WzGBKcVm/WRh0v2TVV8vBHVGiJD+aY5epgRXXI/XUKD0bp8tVV1T7LS-----END PKCS7-----
    ">
    <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
    <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
    </form>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="application.html"
                        title="previous chapter">Application</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="calling.html"
                        title="next chapter">Calling Tasks</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/userguide/tasks.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="calling.html" title="Calling Tasks"
             >next</a> |</li>
        <li class="right" >
          <a href="application.html" title="Application"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Celery 4.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >User Guide</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../copyright.html">Copyright</a> 2009-2017, Ask Solem &amp; contributors.
    </div>
  </body>
</html>