
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Next Steps &#8212; Celery 4.2.0 documentation</title>
    <link rel="stylesheet" href="../_static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Resources" href="resources.html" />
    <link rel="prev" title="First Steps with Celery" href="first-steps-with-celery.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resources.html" title="Resources"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="first-steps-with-celery.html" title="First Steps with Celery"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Celery 4.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Getting Started</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<div class="deck">

    
        <p>
        This document describes the current stable version of Celery (4.2).
        For development docs,
        <a href="http://docs.celeryproject.org/en/master/getting-started/next-steps.html">go here</a>.
        </p>
    

</div>
    <div class="section" id="next-steps">
<span id="id1"></span><h1>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="first-steps-with-celery.html#first-steps"><span class="std std-ref">First Steps with Celery</span></a> guide is intentionally minimal. In this guide
I’ll demonstrate what Celery offers in more detail, including
how to add Celery support for your application and library.</p>
<p>This document doesn’t document all of Celery’s features and
best practices, so it’s recommended that you also read the
<a class="reference internal" href="../userguide/index.html#guide"><span class="std std-ref">User Guide</span></a></p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#using-celery-in-your-application" id="id3">Using Celery in your Application</a></li>
<li><a class="reference internal" href="#calling-tasks" id="id4">Calling Tasks</a></li>
<li><a class="reference internal" href="#canvas-designing-work-flows" id="id5"><em>Canvas</em>: Designing Work-flows</a></li>
<li><a class="reference internal" href="#routing" id="id6">Routing</a></li>
<li><a class="reference internal" href="#remote-control" id="id7">Remote Control</a></li>
<li><a class="reference internal" href="#timezone" id="id8">Timezone</a></li>
<li><a class="reference internal" href="#optimization" id="id9">Optimization</a></li>
<li><a class="reference internal" href="#what-to-do-now" id="id10">What to do now?</a></li>
</ul>
</div>
<div class="section" id="using-celery-in-your-application">
<h2><a class="toc-backref" href="#id3">Using Celery in your Application</a><a class="headerlink" href="#using-celery-in-your-application" title="Permalink to this headline">¶</a></h2>
<div class="section" id="our-project">
<span id="project-layout"></span><h3>Our Project<a class="headerlink" href="#our-project" title="Permalink to this headline">¶</a></h3>
<p>Project layout:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">proj</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
    <span class="o">/</span><span class="n">celery</span><span class="o">.</span><span class="n">py</span>
    <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<div class="section" id="proj-celery-py">
<h4><code class="file docutils literal notranslate"><span class="pre">proj/celery.py</span></code><a class="headerlink" href="#proj-celery-py" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span>
             <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">,</span>
             <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">,</span>
             <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;proj.tasks&#39;</span><span class="p">])</span>

<span class="c1"># Optional configuration, see the application user guide.</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">result_expires</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>In this module you created our <a class="reference internal" href="../reference/celery.html#celery.Celery" title="celery.Celery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Celery</span></code></a> instance (sometimes
referred to as the <em>app</em>). To use Celery within your project
you simply import this instance.</p>
<ul>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">broker</span></code> argument specifies the URL of the broker to use.</p>
<blockquote>
<div><p>See <a class="reference internal" href="first-steps-with-celery.html#celerytut-broker"><span class="std std-ref">Choosing a Broker</span></a> for more information.</p>
</div></blockquote>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">backend</span></code> argument specifies the result backend to use,</p>
<blockquote>
<div><p>It’s used to keep track of task state and results.
While results are disabled by default I use the RPC result backend here
because I demonstrate how retrieving results work later, you may want to use
a different backend for your application. They all have different
strengths and weaknesses. If you don’t need results it’s better
to disable them. Results can also be disabled for individual tasks
by setting the <code class="docutils literal notranslate"><span class="pre">&#64;task(ignore_result=True)</span></code> option.</p>
<p>See <a class="reference internal" href="first-steps-with-celery.html#celerytut-keeping-results"><span class="std std-ref">Keeping Results</span></a> for more information.</p>
</div></blockquote>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">include</span></code> argument is a list of modules to import when
the worker starts. You need to add our tasks module here so
that the worker is able to find our tasks.</p>
</li>
</ul>
</div>
<div class="section" id="proj-tasks-py">
<h4><code class="file docutils literal notranslate"><span class="pre">proj/tasks.py</span></code><a class="headerlink" href="#proj-tasks-py" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span>


<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>


<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">xsum</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="starting-the-worker">
<h3>Starting the worker<a class="headerlink" href="#starting-the-worker" title="Permalink to this headline">¶</a></h3>
<p>The <strong class="program">celery</strong> program can be used to start the worker (you need to run the worker in the directory above proj):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj worker -l info
</pre></div>
</div>
<p>When the worker starts you should see a banner and some messages:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="o">--------------</span> <span class="n">celery</span><span class="nd">@halcyon</span><span class="o">.</span><span class="n">local</span> <span class="n">v4</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">latentcall</span><span class="p">)</span>
<span class="o">----</span> <span class="o">****</span> <span class="o">-----</span>
<span class="o">---</span> <span class="o">*</span> <span class="o">***</span>  <span class="o">*</span> <span class="o">--</span> <span class="p">[</span><span class="n">Configuration</span><span class="p">]</span>
<span class="o">--</span> <span class="o">*</span> <span class="o">-</span> <span class="o">****</span> <span class="o">---</span> <span class="o">.</span> <span class="n">broker</span><span class="p">:</span>      <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">guest</span><span class="nd">@localhost</span><span class="p">:</span><span class="mi">5672</span><span class="o">//</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="o">.</span> <span class="n">app</span><span class="p">:</span>         <span class="n">__main__</span><span class="p">:</span><span class="mh">0x1012d8590</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="o">.</span> <span class="n">concurrency</span><span class="p">:</span> <span class="mi">8</span> <span class="p">(</span><span class="n">processes</span><span class="p">)</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="o">.</span> <span class="n">events</span><span class="p">:</span>      <span class="n">OFF</span> <span class="p">(</span><span class="n">enable</span> <span class="o">-</span><span class="n">E</span> <span class="n">to</span> <span class="n">monitor</span> <span class="n">this</span> <span class="n">worker</span><span class="p">)</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span>
<span class="o">-</span> <span class="o">***</span> <span class="o">---</span> <span class="o">*</span> <span class="o">---</span> <span class="p">[</span><span class="n">Queues</span><span class="p">]</span>
<span class="o">--</span> <span class="o">*******</span> <span class="o">----</span> <span class="o">.</span> <span class="n">celery</span><span class="p">:</span>      <span class="n">exchange</span><span class="p">:</span><span class="n">celery</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span> <span class="n">binding</span><span class="p">:</span><span class="n">celery</span>
<span class="o">---</span> <span class="o">*****</span> <span class="o">-----</span>

<span class="p">[</span><span class="mi">2012</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">51</span><span class="p">,</span><span class="mi">078</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">celery</span><span class="nd">@halcyon</span><span class="o">.</span><span class="n">local</span> <span class="n">has</span> <span class="n">started</span><span class="o">.</span>
</pre></div>
</div>
<p>– The <em>broker</em> is the URL you specified in the broker argument in our <code class="docutils literal notranslate"><span class="pre">celery</span></code>
module, you can also specify a different broker on the command-line by using
the <a class="reference internal" href="../reference/celery.bin.celery.html#cmdoption-celery-b"><code class="xref std std-option docutils literal notranslate"><span class="pre">-b</span></code></a> option.</p>
<p>– <em>Concurrency</em> is the number of prefork worker process used
to process your tasks concurrently, when all of these are busy doing work
new tasks will have to wait for one of the tasks to finish before
it can be processed.</p>
<p>The default concurrency number is the number of CPU’s on that machine
(including cores), you can specify a custom number using
the <a class="reference internal" href="../reference/celery.bin.worker.html#cmdoption-celery-worker-c"><code class="xref std std-option docutils literal notranslate"><span class="pre">celery</span> <span class="pre">worker</span> <span class="pre">-c</span></code></a> option.
There’s no recommended value, as the optimal number depends on a number of
factors, but if your tasks are mostly I/O-bound then you can try to increase
it, experimentation has shown that adding more than twice the number
of CPU’s is rarely effective, and likely to degrade performance
instead.</p>
<p>Including the default prefork pool, Celery also supports using
Eventlet, Gevent, and running in a single thread (see <a class="reference internal" href="../userguide/concurrency/index.html#concurrency"><span class="std std-ref">Concurrency</span></a>).</p>
<p>– <em>Events</em> is an option that when enabled causes Celery to send
monitoring messages (events) for actions occurring in the worker.
These can be used by monitor programs like <code class="docutils literal notranslate"><span class="pre">celery</span> <span class="pre">events</span></code>,
and Flower - the real-time Celery monitor, that you can read about in
the <a class="reference internal" href="../userguide/monitoring.html#guide-monitoring"><span class="std std-ref">Monitoring and Management guide</span></a>.</p>
<p>– <em>Queues</em> is the list of queues that the worker will consume
tasks from. The worker can be told to consume from several queues
at once, and this is used to route messages to specific workers
as a means for Quality of Service, separation of concerns,
and prioritization, all described in the <a class="reference internal" href="../userguide/routing.html#guide-routing"><span class="std std-ref">Routing Guide</span></a>.</p>
<p>You can get a complete list of command-line arguments
by passing in the <a class="reference internal" href="../reference/celery.bin.celery.html#cmdoption-celery-help"><code class="xref std std-option docutils literal notranslate"><span class="pre">--help</span></code></a> flag:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery worker --help
</pre></div>
</div>
<p>These options are described in more detailed in the <a class="reference internal" href="../userguide/workers.html#guide-workers"><span class="std std-ref">Workers Guide</span></a>.</p>
<div class="section" id="stopping-the-worker">
<h4>Stopping the worker<a class="headerlink" href="#stopping-the-worker" title="Permalink to this headline">¶</a></h4>
<p>To stop the worker simply hit <kbd class="kbd docutils literal notranslate">Control-c</kbd>. A list of signals supported
by the worker is detailed in the <a class="reference internal" href="../userguide/workers.html#guide-workers"><span class="std std-ref">Workers Guide</span></a>.</p>
</div>
<div class="section" id="in-the-background">
<h4>In the background<a class="headerlink" href="#in-the-background" title="Permalink to this headline">¶</a></h4>
<p>In production you’ll want to run the worker in the background, this is
described in detail in the <a class="reference internal" href="../userguide/daemonizing.html#daemonizing"><span class="std std-ref">daemonization tutorial</span></a>.</p>
<p>The daemonization scripts uses the <strong class="program">celery multi</strong> command to
start one or more workers in the background:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery multi start w1 -A proj -l info
<span class="go">celery multi v4.0.0 (latentcall)</span>
<span class="gp">&gt;</span> Starting nodes...
<span class="go">    &gt; w1.halcyon.local: OK</span>
</pre></div>
</div>
<p>You can restart it too:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery  multi restart w1 -A proj -l info
<span class="go">celery multi v4.0.0 (latentcall)</span>
<span class="gp">&gt;</span> Stopping nodes...
<span class="go">    &gt; w1.halcyon.local: TERM -&gt; 64024</span>
<span class="gp">&gt;</span> Waiting <span class="k">for</span> <span class="m">1</span> node.....
<span class="go">    &gt; w1.halcyon.local: OK</span>
<span class="gp">&gt;</span> Restarting node w1.halcyon.local: OK
<span class="go">celery multi v4.0.0 (latentcall)</span>
<span class="gp">&gt;</span> Stopping nodes...
<span class="go">    &gt; w1.halcyon.local: TERM -&gt; 64052</span>
</pre></div>
</div>
<p>or stop it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery multi stop w1 -A proj -l info
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">stop</span></code> command is asynchronous so it won’t wait for the
worker to shutdown. You’ll probably want to use the <code class="docutils literal notranslate"><span class="pre">stopwait</span></code> command
instead,  this ensures all currently executing tasks are completed
before exiting:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery multi stopwait w1 -A proj -l info
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong class="program">celery multi</strong> doesn’t store information about workers
so you need to use the same command-line arguments when
restarting. Only the same pidfile and logfile arguments must be
used when stopping.</p>
</div>
<p>By default it’ll create pid and log files in the current directory,
to protect against multiple workers launching on top of each other
you’re encouraged to put these in a dedicated directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir -p /var/run/celery
<span class="gp">$</span> mkdir -p /var/log/celery
<span class="gp">$</span> celery multi start w1 -A proj -l info --pidfile<span class="o">=</span>/var/run/celery/%n.pid <span class="se">\</span>
                                        --logfile<span class="o">=</span>/var/log/celery/%n%I.log
</pre></div>
</div>
<p>With the multi command you can start multiple workers, and there’s a powerful
command-line syntax to specify arguments for different workers too,
for example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery multi start <span class="m">10</span> -A proj -l info -Q:1-3 images,video -Q:4,5 data <span class="se">\</span>
    -Q default -L:4,5 debug
</pre></div>
</div>
<p>For more examples see the <a class="reference internal" href="../reference/celery.bin.multi.html#module-celery.bin.multi" title="celery.bin.multi"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multi</span></code></a> module in the API
reference.</p>
</div>
<div class="section" id="about-the-app-argument">
<span id="app-argument"></span><h4>About the <a class="reference internal" href="../reference/celery.bin.celery.html#cmdoption-celery-a"><code class="xref std std-option docutils literal notranslate"><span class="pre">--app</span></code></a> argument<a class="headerlink" href="#about-the-app-argument" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="../reference/celery.bin.celery.html#cmdoption-celery-a"><code class="xref std std-option docutils literal notranslate"><span class="pre">--app</span></code></a> argument specifies the Celery app instance
to use, it must be in the form of <code class="docutils literal notranslate"><span class="pre">module.path:attribute</span></code></p>
<p>But it also supports a shortcut form If only a package name is specified,
where it’ll try to search for the app instance, in the following order:</p>
<p>With <a class="reference internal" href="../reference/celery.bin.celery.html#cmdoption-celery-a"><code class="xref std std-option docutils literal notranslate"><span class="pre">--app=proj</span></code></a>:</p>
<ol class="arabic simple">
<li>an attribute named <code class="docutils literal notranslate"><span class="pre">proj.app</span></code>, or</li>
<li>an attribute named <code class="docutils literal notranslate"><span class="pre">proj.celery</span></code>, or</li>
<li>any attribute in the module <code class="docutils literal notranslate"><span class="pre">proj</span></code> where the value is a Celery
application, or</li>
</ol>
<p>If none of these are found it’ll try a submodule named <code class="docutils literal notranslate"><span class="pre">proj.celery</span></code>:</p>
<ol class="arabic simple" start="4">
<li>an attribute named <code class="docutils literal notranslate"><span class="pre">proj.celery.app</span></code>, or</li>
<li>an attribute named <code class="docutils literal notranslate"><span class="pre">proj.celery.celery</span></code>, or</li>
<li>Any attribute in the module <code class="docutils literal notranslate"><span class="pre">proj.celery</span></code> where the value is a Celery
application.</li>
</ol>
<p>This scheme mimics the practices used in the documentation – that is,
<code class="docutils literal notranslate"><span class="pre">proj:app</span></code> for a single contained module, and <code class="docutils literal notranslate"><span class="pre">proj.celery:app</span></code>
for larger projects.</p>
</div>
</div>
</div>
<div class="section" id="calling-tasks">
<span id="id2"></span><h2><a class="toc-backref" href="#id4">Calling Tasks</a><a class="headerlink" href="#calling-tasks" title="Permalink to this headline">¶</a></h2>
<p>You can call a task using the <code class="xref py py-meth docutils literal notranslate"><span class="pre">delay()</span></code> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This method is actually a star-argument shortcut to another method called
<code class="xref py py-meth docutils literal notranslate"><span class="pre">apply_async()</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>The latter enables you to specify execution options like the time to run
(countdown), the queue it should be sent to, and so on:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;lopri&#39;</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above example the task will be sent to a queue named <code class="docutils literal notranslate"><span class="pre">lopri</span></code> and the
task will execute, at the earliest, 10 seconds after the message was sent.</p>
<p>Applying the task directly will execute the task in the current process,
so that no message is sent:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">4</span>
</pre></div>
</div>
<p>These three methods - <code class="xref py py-meth docutils literal notranslate"><span class="pre">delay()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">apply_async()</span></code>, and applying
(<code class="docutils literal notranslate"><span class="pre">__call__</span></code>), represents the Celery calling API, that’s also used for
signatures.</p>
<p>A more detailed overview of the Calling API can be found in the
<a class="reference internal" href="../userguide/calling.html#guide-calling"><span class="std std-ref">Calling User Guide</span></a>.</p>
<p>Every task invocation will be given a unique identifier (an UUID), this
is the task id.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">delay</span></code> and <code class="docutils literal notranslate"><span class="pre">apply_async</span></code> methods return an <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a>
instance, that can be used to keep track of the tasks execution state.
But for this you need to enable a <a class="reference internal" href="../userguide/tasks.html#task-result-backends"><span class="std std-ref">result backend</span></a> so that
the state can be stored somewhere.</p>
<p>Results are disabled by default because of the fact that there’s no result
backend that suits every application, so to choose one you need to consider
the drawbacks of each individual backend. For many tasks
keeping the return value isn’t even very useful, so it’s a sensible default to
have. Also note that result backends aren’t used for monitoring tasks and workers,
for that Celery uses dedicated event messages (see <a class="reference internal" href="../userguide/monitoring.html#guide-monitoring"><span class="std std-ref">Monitoring and Management Guide</span></a>).</p>
<p>If you have a result backend configured you can retrieve the return
value of a task:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">4</span>
</pre></div>
</div>
<p>You can find the task’s id by looking at the <code class="xref py py-attr docutils literal notranslate"><span class="pre">id</span></code> attribute:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">id</span>
<span class="go">d6b3aea2-fb9b-4ebc-8da4-848818db9114</span>
</pre></div>
</div>
<p>You can also inspect the exception and traceback if the task raised an
exception, in fact <code class="docutils literal notranslate"><span class="pre">result.get()</span></code> will propagate any errors by default:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytb notranslate"><div class="highlight"><pre><span></span><span class="gt">Traceback (most recent call last):</span>
<span class="gr">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr">File &quot;/opt/devel/celery/celery/result.py&quot;, line 113, in get</span>
<span class="gr">    interval=interval)</span>
<span class="gr">File &quot;/opt/devel/celery/celery/backends/rpc.py&quot;, line 138, in wait_for</span>
<span class="gr">    raise meta[&#39;result&#39;]</span>
<span class="gr">TypeError</span>: <span class="n">add() takes exactly 2 arguments (1 given)</span>
</pre></div>
</div>
<p>If you don’t wish for the errors to propagate then you can disable that
by passing the <code class="docutils literal notranslate"><span class="pre">propagate</span></code> argument:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">propagate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="go">TypeError(&#39;add() takes exactly 2 arguments (1 given)&#39;,)</span>
</pre></div>
</div>
<p>In this case it’ll return the exception instance raised instead,
and so to check whether the task succeeded or failed you’ll have to
use the corresponding methods on the result instance:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">failed</span><span class="p">()</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">successful</span><span class="p">()</span>
<span class="go">False</span>
</pre></div>
</div>
<p>So how does it know if the task has failed or not?  It can find out by looking
at the tasks <em>state</em>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">state</span>
<span class="go">&#39;FAILURE&#39;</span>
</pre></div>
</div>
<p>A task can only be in a single state, but it can progress through several
states. The stages of a typical task can be:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">PENDING</span> <span class="o">-&gt;</span> <span class="n">STARTED</span> <span class="o">-&gt;</span> <span class="n">SUCCESS</span>
</pre></div>
</div>
<p>The started state is a special state that’s only recorded if the
<a class="reference internal" href="../userguide/configuration.html#std:setting-task_track_started"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_track_started</span></code></a> setting is enabled, or if the
<code class="docutils literal notranslate"><span class="pre">&#64;task(track_started=True)</span></code> option is set for the task.</p>
<p>The pending state is actually not a recorded state, but rather
the default state for any task id that’s unknown: this you can see
from this example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.celery</span> <span class="kn">import</span> <span class="n">app</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="s1">&#39;this-id-does-not-exist&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">state</span>
<span class="go">&#39;PENDING&#39;</span>
</pre></div>
</div>
<p>If the task is retried the stages can become even more complex.
To demonstrate, for a task that’s retried two times the stages would be:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PENDING -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; SUCCESS
</pre></div>
</div>
<p>To read more about task states you should see the <a class="reference internal" href="../userguide/tasks.html#task-states"><span class="std std-ref">States</span></a> section
in the tasks user guide.</p>
<p>Calling tasks is described in detail in the
<a class="reference internal" href="../userguide/calling.html#guide-calling"><span class="std std-ref">Calling Guide</span></a>.</p>
</div>
<div class="section" id="canvas-designing-work-flows">
<span id="designing-workflows"></span><h2><a class="toc-backref" href="#id5"><em>Canvas</em>: Designing Work-flows</a><a class="headerlink" href="#canvas-designing-work-flows" title="Permalink to this headline">¶</a></h2>
<p>You just learned how to call a task using the tasks <code class="docutils literal notranslate"><span class="pre">delay</span></code> method,
and this is often all you need, but sometimes you may want to pass the
signature of a task invocation to another process or as an argument to another
function, for this Celery uses something called <em>signatures</em>.</p>
<p>A signature wraps the arguments and execution options of a single task
invocation in a way such that it can be passed to functions or even serialized
and sent across the wire.</p>
<p>You can create a signature for the <code class="docutils literal notranslate"><span class="pre">add</span></code> task using the arguments <code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2)</span></code>,
and a countdown of 10 seconds like this:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
<p>There’s also a shortcut using star arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
<div class="section" id="and-there-s-that-calling-api-again">
<h3>And there’s that calling API again…<a class="headerlink" href="#and-there-s-that-calling-api-again" title="Permalink to this headline">¶</a></h3>
<p>Signature instances also supports the calling API: meaning they
have the <code class="docutils literal notranslate"><span class="pre">delay</span></code> and <code class="docutils literal notranslate"><span class="pre">apply_async</span></code> methods.</p>
<p>But there’s a difference in that the signature may already have
an argument signature specified. The <code class="docutils literal notranslate"><span class="pre">add</span></code> task takes two arguments,
so a signature specifying two arguments would make a complete signature:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
<p>But, you can also make incomplete signatures to create what we call
<em>partials</em>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go"># incomplete partial: add(?, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">s2</span></code> is now a partial signature that needs another argument to be complete,
and this can be resolved when calling the signature:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go"># resolves the partial: add(8, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">10</span>
</pre></div>
</div>
<p>Here you added the argument 8 that was prepended to the existing argument 2
forming a complete signature of <code class="docutils literal notranslate"><span class="pre">add(8,</span> <span class="pre">2)</span></code>.</p>
<p>Keyword arguments can also be added later, these are then merged with any
existing keyword arguments, but with new arguments taking precedence:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>   <span class="c1"># debug is now False.</span>
</pre></div>
</div>
<p>As stated signatures supports the calling API: meaning that;</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">sig.apply_async(args=(),</span> <span class="pre">kwargs={},</span> <span class="pre">**options)</span></code></p>
<blockquote>
<div><p>Calls the signature with optional partial arguments and partial
keyword arguments. Also supports partial execution options.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">sig.delay(*args,</span> <span class="pre">**kwargs)</span></code></p>
<p>Star argument version of <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>. Any arguments will be prepended
to the arguments in the signature, and keyword arguments is merged with any
existing keys.</p>
</li>
</ul>
<p>So this all seems very useful, but what can you actually do with these?
To get to that I must introduce the canvas primitives…</p>
</div>
<div class="section" id="the-primitives">
<h3>The Primitives<a class="headerlink" href="#the-primitives" title="Permalink to this headline">¶</a></h3>
<div class="topic">
<p class="topic-title first"></p>
<table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="../userguide/canvas.html#canvas-group"><span class="std std-ref">group</span></a></li>
<li><a class="reference internal" href="../userguide/canvas.html#canvas-chain"><span class="std std-ref">chain</span></a></li>
<li><a class="reference internal" href="../userguide/canvas.html#canvas-chord"><span class="std std-ref">chord</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../userguide/canvas.html#canvas-map"><span class="std std-ref">map</span></a></li>
<li><a class="reference internal" href="../userguide/canvas.html#canvas-map"><span class="std std-ref">starmap</span></a></li>
<li><a class="reference internal" href="../userguide/canvas.html#canvas-chunks"><span class="std std-ref">chunks</span></a></li>
</ul>
</td></tr></table>
</div>
<p>These primitives are signature objects themselves, so they can be combined
in any number of ways to compose complex work-flows.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These examples retrieve results, so to try them out you need
to configure a result backend. The example project
above already does that (see the backend argument to <a class="reference internal" href="../reference/celery.html#celery.Celery" title="celery.Celery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Celery</span></code></a>).</p>
</div>
<p>Let’s look at some examples:</p>
<div class="section" id="groups">
<h4>Groups<a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h4>
<p>A <a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> calls a list of tasks in parallel,
and it returns a special result instance that lets you inspect the results
as a group, and retrieve the return values in order.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>
</pre></div>
</div>
<ul class="simple">
<li>Partial group</li>
</ul>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[10, 11, 12, 13, 14, 15, 16, 17, 18, 19]</span>
</pre></div>
</div>
</div>
<div class="section" id="chains">
<h4>Chains<a class="headerlink" href="#chains" title="Permalink to this headline">¶</a></h4>
<p>Tasks can be linked together so that after one task returns the other
is called:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">mul</span>

<span class="go"># (4 + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>
</pre></div>
</div>
<p>or a partial chain:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># (? + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>
</pre></div>
</div>
<p>Chains can also be written like this:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>
</pre></div>
</div>
</div>
<div class="section" id="chords">
<h4>Chords<a class="headerlink" href="#chords" title="Permalink to this headline">¶</a></h4>
<p>A chord is a group with a callback:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chord</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">xsum</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">chord</span><span class="p">((</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>A group chained to another task will be automatically converted
to a chord:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>Since these primitives are all of the signature type they
can be combined almost however you want, for example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">upload_document</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="o">|</span> <span class="n">group</span><span class="p">(</span><span class="n">apply_filter</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">)</span>
</pre></div>
</div>
<p>Be sure to read more about work-flows in the <a class="reference internal" href="../userguide/canvas.html#guide-canvas"><span class="std std-ref">Canvas</span></a> user
guide.</p>
</div>
</div>
</div>
<div class="section" id="routing">
<h2><a class="toc-backref" href="#id6">Routing</a><a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h2>
<p>Celery supports all of the routing facilities provided by AMQP,
but it also supports simple routing where messages are sent to named queues.</p>
<p>The <a class="reference internal" href="../userguide/configuration.html#std:setting-task_routes"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_routes</span></code></a> setting enables you to route tasks by name
and keep everything centralized in one location:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">task_routes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;proj.tasks.add&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;hipri&#39;</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can also specify the queue at runtime
with the <code class="docutils literal notranslate"><span class="pre">queue</span></code> argument to <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;hipri&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can then make a worker consume from this queue by
specifying the <a class="reference internal" href="../reference/celery.bin.worker.html#cmdoption-celery-worker-q"><code class="xref std std-option docutils literal notranslate"><span class="pre">celery</span> <span class="pre">worker</span> <span class="pre">-Q</span></code></a> option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj worker -Q hipri
</pre></div>
</div>
<p>You may specify multiple queues by using a comma separated list,
for example you can make the worker consume from both the default
queue, and the <code class="docutils literal notranslate"><span class="pre">hipri</span></code> queue, where
the default queue is named <code class="docutils literal notranslate"><span class="pre">celery</span></code> for historical reasons:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj worker -Q hipri,celery
</pre></div>
</div>
<p>The order of the queues doesn’t matter as the worker will
give equal weight to the queues.</p>
<p>To learn more about routing, including taking use of the full
power of AMQP routing, see the <a class="reference internal" href="../userguide/routing.html#guide-routing"><span class="std std-ref">Routing Guide</span></a>.</p>
</div>
<div class="section" id="remote-control">
<h2><a class="toc-backref" href="#id7">Remote Control</a><a class="headerlink" href="#remote-control" title="Permalink to this headline">¶</a></h2>
<p>If you’re using RabbitMQ (AMQP), Redis, or Qpid as the broker then
you can control and inspect the worker at runtime.</p>
<p>For example you can see what tasks the worker is currently working on:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj inspect active
</pre></div>
</div>
<p>This is implemented by using broadcast messaging, so all remote
control commands are received by every worker in the cluster.</p>
<p>You can also specify one or more workers to act on the request
using the <a class="reference internal" href="../reference/celery.bin.celery.html#cmdoption-celery-inspect-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> option.
This is a comma separated list of worker host names:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj inspect active --destination<span class="o">=</span>celery@example.com
</pre></div>
</div>
<p>If a destination isn’t provided then every worker will act and reply
to the request.</p>
<p>The <strong class="program">celery inspect</strong> command contains commands that
doesn’t change anything in the worker, it only replies information
and statistics about what’s going on inside the worker.
For a list of inspect commands you can execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj inspect --help
</pre></div>
</div>
<p>Then there’s the <strong class="program">celery control</strong> command, that contains
commands that actually changes things in the worker at runtime:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj control --help
</pre></div>
</div>
<p>For example you can force workers to enable event messages (used
for monitoring tasks and workers):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj control enable_events
</pre></div>
</div>
<p>When events are enabled you can then start the event dumper
to see what the workers are doing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj events --dump
</pre></div>
</div>
<p>or you can start the curses interface:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj events
</pre></div>
</div>
<p>when you’re finished monitoring you can disable events again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj control disable_events
</pre></div>
</div>
<p>The <strong class="program">celery status</strong> command also uses remote control commands
and shows a list of online workers in the cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A proj status
</pre></div>
</div>
<p>You can read more about the <strong class="program">celery</strong> command and monitoring
in the <a class="reference internal" href="../userguide/monitoring.html#guide-monitoring"><span class="std std-ref">Monitoring Guide</span></a>.</p>
</div>
<div class="section" id="timezone">
<h2><a class="toc-backref" href="#id8">Timezone</a><a class="headerlink" href="#timezone" title="Permalink to this headline">¶</a></h2>
<p>All times and dates, internally and in messages uses the UTC timezone.</p>
<p>When the worker receives a message, for example with a countdown set it
converts that UTC time to local time. If you wish to use
a different timezone than the system timezone then you must
configure that using the <a class="reference internal" href="../userguide/configuration.html#std:setting-timezone"><code class="xref std std-setting docutils literal notranslate"><span class="pre">timezone</span></code></a> setting:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="s1">&#39;Europe/London&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="optimization">
<h2><a class="toc-backref" href="#id9">Optimization</a><a class="headerlink" href="#optimization" title="Permalink to this headline">¶</a></h2>
<p>The default configuration isn’t optimized for throughput by default,
it tries to walk the middle way between many short tasks and fewer long
tasks, a compromise between throughput and fair scheduling.</p>
<p>If you have strict fair scheduling requirements, or want to optimize
for throughput then you should read the <a class="reference internal" href="../userguide/optimizing.html#guide-optimizing"><span class="std std-ref">Optimizing Guide</span></a>.</p>
<p>If you’re using RabbitMQ then you can install the <a class="reference external" href="https://pypi.python.org/pypi/librabbitmq/">librabbitmq</a>
module: this is an AMQP client implemented in C:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> pip install librabbitmq
</pre></div>
</div>
</div>
<div class="section" id="what-to-do-now">
<h2><a class="toc-backref" href="#id10">What to do now?</a><a class="headerlink" href="#what-to-do-now" title="Permalink to this headline">¶</a></h2>
<p>Now that you have read this document you should continue
to the <a class="reference internal" href="../userguide/index.html#guide"><span class="std std-ref">User Guide</span></a>.</p>
<p>There’s also an <a class="reference internal" href="../reference/index.html#apiref"><span class="std std-ref">API reference</span></a> if you’re so inclined.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/celery_512.png" alt="Logo"/>
            </a></p><iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>
<div id="donate">
    <b>Please help support this community project with a donation:</b>
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
    <input type="hidden" name="cmd" value="_s-xclick">
    <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----MIIHTwYJKoZIhvcNAQcEoIIHQDCCBzwCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYA2+c723xlntHKQYQR9yn9BEtUhDoUUlnOqhniqvNMWB4k2R0JpVkrNSu5JCbdjNOqDXKHoRfIWe3HXJJMPZBJKFMD5Izprb6xEZlTGaWnlrGXFfkdBaILQQgWYqV0DnuNmtDXCvfYmyu0p1K04wLjAJ1ufnBSP1UaS6BTcoIOOuTELMAkGBSsOAwIaBQAwgcwGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIFg/2qPwa7UCAgah20QLIllcp0VHazYo2C9h8c6gn8MTcTnpW0WFXhz9ylc/i5dCXabkrrLBBfg8NygAuvYRr4k1zdC0AJIgsV/6rSAhehabRvjRDH2EZ8OieqHfIPfkAcTm+JqbS6Z27lXkebYPnJzhkZxW7+ZC6hU/H40JFXChTag8lhqJfZELiOZLWxxilj2mkwlkdMx1YL6lcPAA7ajpAwjsnJYd/9VxLA6MDmcOu+TKgggOHMIIDgzCCAuygAwIBAgIBADANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wHhcNMDQwMjEzMTAxMzE1WhcNMzUwMjEzMTAxMzE1WjCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMFHTt38RMxLXJyO2SmS+Ndl72T7oKJ4u4uw+6awntALWh03PewmIJuzbALScsTS4sZoS1fKciBGoh11gIfHzylvkdNe/hJl66/RGqrj5rFb08sAABNTzDTiqqNpJeBsYs/c2aiGozptX2RlnBktH+SUNpAajW724Nv2Wvhif6sFAgMBAAGjge4wgeswHQYDVR0OBBYEFJaffLvGbxe9WT9S1wob7BDWZJRrMIG7BgNVHSMEgbMwgbCAFJaffLvGbxe9WT9S1wob7BDWZJRroYGUpIGRMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbYIBADAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA4GBAIFfOlaagFrl71+jq6OKidbWFSE+Q4FqROvdgIONth+8kSK//Y/4ihuE4Ymvzn5ceE3S/iBSQQMjyvb+s2TWbQYDwcp129OPIbD9epdr4tJOUNiSojw7BHwYRiPh58S1xGlFgHFXwrEBb3dgNbMUa+u4qectsMAXpVHnD9wIyfmHMYIBmjCCAZYCAQEwgZQwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tAgEAMAkGBSsOAwIaBQCgXTAYBgkqhkiG9w0BCQMxCwYJKoZIhvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0xNTEyMTAxOTEzMzBaMCMGCSqGSIb3DQEJBDEWBBTUno4gI/mmaVaGVpgB/CWwQd3DeDANBgkqhkiG9w0BAQEFAASBgFmZ1j1Ss/FNl/JRIOakhBJEdm2KGLH0d2ewwTYIgIkEKSdc5Rg2/2xFS/dglcs5Te3R2GzaqjGlNSKldsk/MgZP/BudpHAASQ09hrfDy5TaBlRRl1Yu0WzGBKcVm/WRh0v2TVV8vBHVGiJD+aY5epgRXXI/XUKD0bp8tVV1T7LS-----END PKCS7-----
    ">
    <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
    <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
    </form>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="first-steps-with-celery.html"
                        title="previous chapter">First Steps with Celery</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="resources.html"
                        title="next chapter">Resources</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/getting-started/next-steps.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resources.html" title="Resources"
             >next</a> |</li>
        <li class="right" >
          <a href="first-steps-with-celery.html" title="First Steps with Celery"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Celery 4.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Getting Started</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../copyright.html">Copyright</a> 2009-2017, Ask Solem &amp; contributors.
    </div>
  </body>
</html>